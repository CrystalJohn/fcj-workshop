<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.134.3"><meta name=description content><meta name=author content="phuctptse183992@fpt.edu.vn"><link rel=icon href=../../images/favicon.png type=image/png><title>Building Golden Images with CIS Linux Build Kit in Amazon EC2 Image Builder :: Internship Report</title>
<link href=../../css/nucleus.css?1765512673 rel=stylesheet><link href=../../css/fontawesome-all.min.css?1765512673 rel=stylesheet><link href=../../css/hybrid.css?1765512673 rel=stylesheet><link href=../../css/featherlight.min.css?1765512673 rel=stylesheet><link href=../../css/perfect-scrollbar.min.css?1765512673 rel=stylesheet><link href=../../css/auto-complete.css?1765512673 rel=stylesheet><link href=../../css/atom-one-dark-reasonable.css?1765512673 rel=stylesheet><link href=../../css/theme.css?1765512673 rel=stylesheet><link href=../../css/hugo-theme.css?1765512673 rel=stylesheet><link href=../../css/theme-workshop.css?1765512673 rel=stylesheet><script src=../../js/jquery-3.3.1.min.js?1765512673></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=../../3-blogstranslated/3.3-blog3/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=../../><svg id="Layer_1" data-name="Layer 1" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff}.cls-2{fill:#f90;fill-rule:evenodd}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09 10.85a4.7 4.7.0 00.19 1.48 7.73 7.73.0 00.54 1.19.77.77.0 01.12.38.64.64.0 01-.32.49l-1 .7a.83.83.0 01-.44.15.69.69.0 01-.49-.23 3.8 3.8.0 01-.6-.77q-.25-.42-.51-1a6.14 6.14.0 01-4.89 2.3 4.54 4.54.0 01-3.32-1.19 4.27 4.27.0 01-1.22-3.2 4.28 4.28.0 011.46-3.4A6.06 6.06.0 017.69 6.46a12.47 12.47.0 011.76.13q.92.13 1.91.36V5.73a3.65 3.65.0 00-.79-2.66A3.81 3.81.0 007.86 2.3a7.71 7.71.0 00-1.79.22 12.78 12.78.0 00-1.79.57 4.55 4.55.0 01-.58.22h-.26q-.35.0-.35-.52V2a1.09 1.09.0 01.12-.58 1.2 1.2.0 01.47-.35A10.88 10.88.0 015.77.32 10.19 10.19.0 018.36.0a6 6 0 014.35 1.35 5.49 5.49.0 011.38 4.09zM7.34 13.38a5.36 5.36.0 001.72-.31A3.63 3.63.0 0010.63 12 2.62 2.62.0 0011.19 11a5.63 5.63.0 00.16-1.44v-.7a14.35 14.35.0 00-1.53-.28 12.37 12.37.0 00-1.56-.1 3.84 3.84.0 00-2.47.67A2.34 2.34.0 005 11a2.35 2.35.0 00.61 1.76A2.4 2.4.0 007.34 13.38zm13.35 1.8a1 1 0 01-.64-.16 1.3 1.3.0 01-.35-.65L15.81 1.51a3 3 0 01-.15-.67.36.36.0 01.41-.41H17.7a1 1 0 01.65.16 1.4 1.4.0 01.33.65l2.79 11 2.59-11A1.17 1.17.0 0124.39.6a1.1 1.1.0 01.67-.16H26.4a1.1 1.1.0 01.67.16 1.17 1.17.0 01.32.65L30 12.39 32.88 1.25A1.39 1.39.0 0133.22.6a1 1 0 01.65-.16h1.54a.36.36.0 01.41.41 1.36 1.36.0 010 .26 3.64 3.64.0 01-.12.41l-4 12.86a1.3 1.3.0 01-.35.65 1 1 0 01-.64.16H29.25a1 1 0 01-.67-.17 1.26 1.26.0 01-.32-.67L25.67 3.64l-2.56 10.7a1.26 1.26.0 01-.32.67 1 1 0 01-.67.17zm21.36.44a11.28 11.28.0 01-2.56-.29 7.44 7.44.0 01-1.92-.67 1 1 0 01-.61-.93v-.84q0-.52.38-.52a.9.9.0 01.31.06l.42.17a8.77 8.77.0 001.83.58 9.78 9.78.0 002 .2 4.48 4.48.0 002.43-.55 1.76 1.76.0 00.86-1.57 1.61 1.61.0 00-.45-1.16A4.29 4.29.0 0043 9.22l-2.41-.76A5.15 5.15.0 0138 6.78a3.94 3.94.0 01-.83-2.41 3.7 3.7.0 01.45-1.85 4.47 4.47.0 011.19-1.37 5.27 5.27.0 011.7-.86A7.4 7.4.0 0142.6.0a8.87 8.87.0 011.12.07q.57.07 1.08.19t.95.26a4.27 4.27.0 01.7.29 1.59 1.59.0 01.49.41.94.94.0 01.15.55v.79q0 .52-.38.52a1.76 1.76.0 01-.64-.2 7.74 7.74.0 00-3.2-.64 4.37 4.37.0 00-2.21.47 1.6 1.6.0 00-.79 1.48 1.58 1.58.0 00.49 1.18 4.94 4.94.0 001.83.92L44.55 7a5.08 5.08.0 012.57 1.6A3.76 3.76.0 0147.9 11a4.21 4.21.0 01-.44 1.93 4.4 4.4.0 01-1.21 1.47 5.43 5.43.0 01-1.85.93A8.25 8.25.0 0142.05 15.62z"/><path class="cls-2" d="M45.19 23.81C39.72 27.85 31.78 30 25 30A36.64 36.64.0 01.22 20.57c-.51-.46-.06-1.09.56-.74A49.78 49.78.0 0025.53 26.4 49.23 49.23.0 0044.4 22.53C45.32 22.14 46.1 23.14 45.19 23.81z"/><path class="cls-2" d="M47.47 21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74 3.13-2.2 8.27-1.57 8.86-.83s-.16 5.89-3.09 8.35c-.45.38-.88.18-.68-.32C46.69 25.8 48.17 22.11 47.47 21.21z"/></svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=../../js/lunr.min.js?1765512673></script><script type=text/javascript src=../../js/auto-complete.js?1765512673></script><script type=text/javascript>var baseurl="https://crystaljohn.github.io/fcj-workshop/"</script><script type=text/javascript src=../../js/search.js?1765512673></script></div><div class=highlightable><ul class=topics><li data-nav-id=/1-worklog/ title=Worklog class=dd-item><a href=../../1-worklog/><b>1. </b>Worklog
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/1-worklog/1.7-week7/ title="Week 7 Worklog" class=dd-item><a href=../../1-worklog/1.7-week7/><b>1.7. </b>Week 7 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.1-week1/ title="Week 1 Worklog" class=dd-item><a href=../../1-worklog/1.1-week1/><b>1.1. </b>Week 1 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.2-week2/ title="Week 2 Worklog" class=dd-item><a href=../../1-worklog/1.2-week2/><b>1.2. </b>Week 2 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.3-week3/ title="Week 3 Worklog" class=dd-item><a href=../../1-worklog/1.3-week3/><b>1.3. </b>Week 3 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.4-week4/ title="Week 4 Worklog" class=dd-item><a href=../../1-worklog/1.4-week4/><b>1.4. </b>Week 4 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.5-week5/ title="Week 5 Worklog" class=dd-item><a href=../../1-worklog/1.5-week5/><b>1.5. </b>Week 5 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.6-week6/ title="Week 6 Worklog" class=dd-item><a href=../../1-worklog/1.6-week6/><b>1.6. </b>Week 6 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.8-week8/ title="Week 8 Worklog" class=dd-item><a href=../../1-worklog/1.8-week8/><b>1.8. </b>Week 8 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.9-week9/ title="Week 9 Worklog" class=dd-item><a href=../../1-worklog/1.9-week9/><b>1.9. </b>Week 9 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.10-week10/ title="Week 10 Worklog" class=dd-item><a href=../../1-worklog/1.10-week10/><b>1.10. </b>Week 10 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.11-week11/ title="Week 11 Worklog" class=dd-item><a href=../../1-worklog/1.11-week11/><b>1.11. </b>Week 11 Worklog
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/1-worklog/1.12-week12/ title="Week 12 Worklog" class=dd-item><a href=../../1-worklog/1.12-week12/><b>1.12 </b>Week 12 Worklog
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/2-proposal/ title=Proposal class=dd-item><a href=../../2-proposal/><b>2. </b>Proposal
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3-blogstranslated/ title="Translated Blogs" class="dd-item
parent"><a href=../../3-blogstranslated/><b>3. </b>Translated Blogs
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/3-blogstranslated/3.1-blog1/ title="Build a Virtual Meteorologist Using Amazon Bedrock Agents" class=dd-item><a href=../../3-blogstranslated/3.1-blog1/><b>3.1. </b>Build a Virtual Meteorologist Using Amazon Bedrock Agents
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3-blogstranslated/3.2-blog2/ title="Build end-to-end Apache Spark pipelines with Amazon MWAA, Batch Processing Gateway, and Amazon EMR on EKS" class=dd-item><a href=../../3-blogstranslated/3.2-blog2/><b>3.2. </b>Build end-to-end Apache Spark pipelines with Amazon MWAA, Batch Processing Gateway, and Amazon EMR on EKS
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/3-blogstranslated/3.3-blog3/ title="Building Golden Images with CIS Linux Build Kit in Amazon EC2 Image Builder" class="dd-item
active"><a href=../../3-blogstranslated/3.3-blog3/><b>3.3. </b>Building Golden Images with CIS Linux Build Kit in Amazon EC2 Image Builder
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/4-eventparticipated/ title="Events Participated" class=dd-item><a href=../../4-eventparticipated/><b>4. </b>Events Participated
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/4-eventparticipated/4.1-event1/ title="Event 1" class=dd-item><a href=../../4-eventparticipated/4.1-event1/><b>4.1. </b>Event 1
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4-eventparticipated/4.2-event2/ title="Event 2" class=dd-item><a href=../../4-eventparticipated/4.2-event2/><b>4.2. </b>Event 2
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4-eventparticipated/4.3-event3/ title="Event 3" class=dd-item><a href=../../4-eventparticipated/4.3-event3/><b>4.2. </b>Event 3
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/4-eventparticipated/4.4-event4/ title="Event 4" class=dd-item><a href=../../4-eventparticipated/4.4-event4/><b>4.2. </b>Event 4
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/5-workshop/ title=Workshop class=dd-item><a href=../../5-workshop/><b>5. </b>Workshop
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/5-workshop/1-introduction/ title=Introduction class=dd-item><a href=../../5-workshop/1-introduction/><b>1. </b>Introduction
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/2-preparation/ title=Preparation class=dd-item><a href=../../5-workshop/2-preparation/><b>2. </b>Preparation
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/3-bedrock-models/ title="Activate Bedrock Models" class=dd-item><a href=../../5-workshop/3-bedrock-models/><b>3. </b>Activate Bedrock Models
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/4-aws-cli/ title="Configure AWS CLI" class=dd-item><a href=../../5-workshop/4-aws-cli/><b>4. </b>Configure AWS CLI
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/5-data-preparation/ title="Data Preparation" class=dd-item><a href=../../5-workshop/5-data-preparation/><b>5. </b>Data Preparation
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/6-infrastructure/ title="Deploy Infrastructure" class=dd-item><a href=../../5-workshop/6-infrastructure/><b>6. </b>Deploy Infrastructure
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/7-backend/ title="Set up Backend API" class=dd-item><a href=../../5-workshop/7-backend/><b>7. </b>Set up Backend API
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/8-idp-pipeline/ title="Set up IDP Pipeline" class=dd-item><a href=../../5-workshop/8-idp-pipeline/><b>8. </b>Set up IDP Pipeline
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/9-frontend/ title="Setup Frontend" class=dd-item><a href=../../5-workshop/9-frontend/><b>9. </b>Setup Frontend
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/10-using-chatbot/ title="Using Chatbot" class=dd-item><a href=../../5-workshop/10-using-chatbot/><b>10. </b>Using Chatbot
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/11-admin-dashboard/ title="Using Admin Dashboard" class=dd-item><a href=../../5-workshop/11-admin-dashboard/><b>11. </b>Using Admin Dashboard
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/5-workshop/12-cleanup/ title="Cleanup Resources" class=dd-item><a href=../../5-workshop/12-cleanup/><b>12. </b>Cleanup Resources
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/6-self-evaluation/ title=Self-Assessment class=dd-item><a href=../../6-self-evaluation/><b>6. </b>Self-Assessment
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/7-feedback/ title="Sharing and Feedback" class=dd-item><a href=../../7-feedback/><b>7. </b>Sharing and Feedback
<i class="fas fa-check read-icon"></i></a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://www.facebook.com/groups/awsstudygroupfcj/><i class='fab fa-facebook'></i> AWS Study Group</a></li></ul></section><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value"><option id=en value=https://crystaljohn.github.io/fcj-workshop/3-blogstranslated/3.3-blog3/ selected>English</option><option id=vi value=https://crystaljohn.github.io/fcj-workshop/vi/3-blogstranslated/3.3-blog3/>Tiếng Việt</option></select><svg id="Capa_1" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75"/></g></g></svg></div></a></li><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></section><section id=footer><left><b>Workshop</b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title=Migrate alt="web counter" border=0></a><br><b><a href=https://cloudjourney.awsstudygroup.com/>Cloud Journey</a></b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" alt="web counter" border=0>
</left><left><br><br><b>Last Updated</b><br><i><span id=lastUpdated style=color:orange></span>
</i><script>const today=new Date,formattedDate=today.toLocaleDateString("en-GB");document.getElementById("lastUpdated").textContent=formattedDate</script></left><left><br><br><b>Team</b><br><i><a href=https://www.facebook.com/groups/660548818043427 style=color:orange>First Cloud Journey</a><br></i></left><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=../../>Internship Report</a> > <a href=../../3-blogstranslated/>Translated Blogs</a> > Building Golden Images with CIS Linux Build Kit in Amazon EC2 Image Builder</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#by-rajat-chatterjee>By: Rajat Chatterjee</a></li><li><a href=#introduction>Introduction</a></li><li><a href=#solution-overview>Solution overview</a></li><li><a href=#solution-prerequisites>Solution prerequisites</a><ul><li><a href=#download-explore-and-update-cis-lbk-utility>Download, explore, and update CIS LBK Utility</a></li><li><a href=#create-staging-s3-bucket-and-upload-lbk>Create staging S3 bucket and upload LBK</a></li><li><a href=#configure-s3-bucket-to-send-notifications-via-amazon-eventbridge>Configure S3 bucket to send notifications via Amazon EventBridge</a></li></ul></li><li><a href=#deployment-steps>Deployment steps</a></li><li><a href=#building-image-building-pipeline-with-ec2-image-builder>Building Image Building Pipeline with EC2 Image Builder</a><ul><li><a href=#create-custom-component-for-ec2-image-builder>Create custom Component for EC2 Image Builder</a></li><li><a href=#create-image-recipe-based-on-component>Create Image Recipe based on Component</a></li><li><a href=#create-custom-workflow-for-image-build-process>Create custom Workflow for Image Build process</a></li><li><a href=#create-image-pipeline>Create Image Pipeline</a></li><li><a href=#attach-bucket-policy-to-s3-bucket-cis-lbk-al2>Attach Bucket Policy to S3 Bucket cis-lbk-al2</a></li><li><a href=#create-amazon-sns-topic-for-email-notification>Create Amazon SNS Topic for Email Notification</a></li><li><a href=#create-amazon-eventbridge-rules-to-send-notifications>Create Amazon EventBridge Rules to send notifications</a></li><li><a href=#run-image-pipeline>Run Image Pipeline</a></li></ul></li><li><a href=#testing-image-with-amazon-inspector>Testing Image with Amazon Inspector</a><ul><li><a href=#continue-or-stop-workflow>Continue or stop workflow</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#further-reading>Further reading</a></li><li><a href=#about-the-author>About the author</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Building Golden Images with CIS Linux Build Kit in Amazon EC2 Image Builder</h1><h2 id=by-rajat-chatterjee>By: Rajat Chatterjee</h2><p><strong>Date:</strong> May 11, 2025</p><p><strong>Topics:</strong> <a href=https://aws.amazon.com/blogs/mt/category/security-identity-compliance/amazon-inspector/>Amazon Inspector</a>, <a href=https://aws.amazon.com/blogs/mt/category/management-and-governance/enterprise-governance-and-control/>Enterprise Governance and Control</a>, <a href=https://aws.amazon.com/blogs/mt/category/learning-levels/expert-400/>Expert (400)</a>, <a href=https://aws.amazon.com/blogs/mt/category/management-tools/>Management Tools</a>, <a href=https://aws.amazon.com/blogs/mt/category/post-types/technical-how-to/>Technical How-to</a></p><hr><h2 id=introduction>Introduction</h2><p>Building and deploying hardened and security-certified operating systems (OS) is an essential requirement for any Cloud Operations (CloudOps) or Cloud Center of Excellence (CCoE) team in an organization. The security guidelines and controls used to certify these images typically come from internal security teams, based on widely recognized industry standards.</p><p>However, you also need the ability to control the hardening process, with flexibility to choose appropriate remediation steps and application deployment scenarios. The result is the formation of &ldquo;<a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html>Golden Amazon Machine Images</a> (AMI)&rdquo; – images that Business Units use directly.</p><p>This process requires automation, so that building and testing can occur at scale and images are distributed through approved <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html>Amazon Machine Images</a> (AMI). One of the popular standards used as a baseline for image hardening is the <a href=https://www.cisecurity.org/>Center for Internet Security</a> (CIS) — an organization that creates and maintains a set of configuration guidelines called <a href=https://www.cisecurity.org/benchmark>CIS Benchmarks</a>, providing best practice configurations for specific technologies such as operating systems, cloud platforms, applications, and databases.</p><p><a href=https://www.cisecurity.org/benchmark>CIS Benchmarks</a> are widely recognized in the industry and referenced by many standards such as PCI DSS, HIPAA, DoD Cloud Computing SRG, FISMA, DFARS, and FEDRAMP.</p><p>In this post, we choose the CIS benchmark for Amazon Linux, and build a process to create certified AMIs through automation that can operate at scale.</p><p>You can use one of two approaches to create Golden Images by applying <a href=https://www.cisecurity.org/cis-benchmarks>CIS Benchmark</a> for the corresponding operating system (OS) to harden the AMI:</p><ol><li><p><strong>Use managed components with CIS AMI from <a href=https://aws.amazon.com/marketplace/>AWS Marketplace</a></strong> – You will also have access to the accompanying hardening component, which runs scripts to apply <a href=https://www.cisecurity.org/cis-benchmarks>CIS Benchmark</a> Level 1 guidelines to your configuration. These components are owned and maintained by CIS to ensure they are always updated with the latest guidelines. (Details on this approach can be found in the post <a href=https://aws.amazon.com/blogs/mt/building-cis-hardened-golden-images-and-pipelines-with-ec2-image-builder/>Building CIS hardened Golden Images and Pipelines with EC2 Image Builder</a>).</p></li><li><p><strong>Use a self-managed hardening process with <a href=https://aws.amazon.com/image-builder/>Amazon EC2 Image Builder</a></strong> – This approach provides flexibility for CloudOps teams to customize the hardening process, allowing them to exclude benchmark recommendations that may affect applications intended for deployment on instances using the AMI.</p></li></ol><p>You can choose one of these two options after carefully analyzing the factors explained in the post <a href=https://aws.amazon.com/blogs/apn/how-to-decide-between-building-or-buying-a-cis-hardened-image/>How to Decide Between Building or Buying a CIS Hardened Image</a>.</p><p>In this post, we will demonstrate how to use scripts published by CIS Linux Build Kit (LBK) to create a self-managed hardening and validation process using <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> and <a href=https://aws.amazon.com/inspector/>Amazon Inspector</a>. The scripts needed to harden a specific operating system (according to <a href=https://www.cisecurity.org/cis-benchmarks>CIS Benchmark</a>) are published on the CIS Workbench page, downloadable if your organization is a CIS SecureSuite® member. These scripts can be reused with minimal modifications to create <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> Components, then used in Image Builder Pipelines.</p><p>We will implement this approach by creating a hardened <a href=https://aws.amazon.com/amazon-linux-2/>Amazon Linux 2</a> AMI, and validating it using <a href=https://aws.amazon.com/inspector/>Amazon Inspector</a>.</p><hr><h2 id=solution-overview>Solution overview</h2><p>The solution consists of the following main steps:</p><p><strong>Prerequisites:</strong></p><ol><li>Have an AWS account with appropriate permissions.</li><li>Download, explore, and update the CIS LBK Utility.</li><li>Create an <a href=https://aws.amazon.com/s3/>Amazon S3</a> bucket as a staging environment to upload the CIS LBK Utility.</li><li>Configure the S3 bucket to send notifications via <a href=https://aws.amazon.com/eventbridge/>Amazon EventBridge</a>.</li></ol><p><strong>Main deployment steps:</strong></p><ol><li>Build the Image Building Pipeline using <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a>.</li><li>Validate the image and generate reports using <a href=https://aws.amazon.com/inspector/>Amazon Inspector</a>.</li></ol><hr><h2 id=solution-prerequisites>Solution prerequisites</h2><h3 id=download-explore-and-update-cis-lbk-utility>Download, explore, and update CIS LBK Utility</h3><p>The LBK for <a href=https://aws.amazon.com/amazon-linux-2/>Amazon Linux 2</a> can be downloaded from the CIS website. This toolkit is developed and maintained by the CIS community, currently distributed as the file <code>amazon_linux_2.tar.gz</code>.</p><p>After extracting the tar file, you will see the following directory structure:</p><p><img alt="CIS Linux Build Kit folder structure" src=../../images/3-BlogsTranslated/3.3-Blog3/cis-folders.jpg></p><p><em>Figure 1: CIS Linux Build Kit folder structure</em></p><p>The main directory contains the file <code>amazon_linux_2.sh</code> — the main script that calls sub-scripts in the &ldquo;functions&rdquo; directory. If you want to exclude certain recommendations, add them to the <code>exclusion_list.txt</code> file.</p><p>Usage instructions and toolkit contents are described in detail in the Quick Start Guide included in the package. The <code>amazon_linux_2.sh</code> script includes two interactive steps when running. For automation, you should modify this script to hardcode the input values.</p><p>Specifically, you need to:</p><ol><li><p><strong>Accept the Terms and Conditions</strong> – you should comment out this line in the script, and the CloudOps team can provide separate terms content for users in internal documentation.</p></li><li><p><strong>Select the hardening profile</strong> – there are four profiles: L1S, L2S, L1W, L2W corresponding to Level 1/2 of <a href=https://www.cisecurity.org/cis-benchmarks>CIS Benchmark</a>, and Server (S) or Workstation (W) type.</p></li></ol><p>In this example, we will use the L1S profile to harden <a href=https://aws.amazon.com/amazon-linux-2/>Amazon Linux 2</a> according to <a href=https://www.cisecurity.org/cis-benchmarks>CIS Benchmark</a> Level 1.</p><p>Lines to modify in the script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#terms_of_use</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#Display CIS Linux Build Kit warning banner</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#WARBNR ---&gt; Comment this line</span>
</span></span><span style=display:flex><span>run_profile<span style=color:#f92672>=</span>L1S <span style=color:#75715e># Uncomment this line to specify the profile to run</span>
</span></span></code></pre></div><p>After editing, repackage the LBK file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tar cvf amazon_linux_2.tar.gz CIS-LBK
</span></span></code></pre></div><h3 id=create-staging-s3-bucket-and-upload-lbk>Create staging S3 bucket and upload LBK</h3><p>Create an S3 bucket (e.g., <code>cis-lbk-al2</code>) using AWS Management Console or <a href=https://aws.amazon.com/cli/>AWS CLI</a>. This bucket is used to store the LBK script, serving <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> for downloading and uploading logs after execution.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws s3api put-object --bucket cis-lbk-al2 --key amazon_linux_2.tar.gz --body amazon_linux_2.tar.gz
</span></span></code></pre></div><h3 id=configure-s3-bucket-to-send-notifications-via-amazon-eventbridge>Configure S3 bucket to send notifications via Amazon EventBridge</h3><p>Enable <a href=https://aws.amazon.com/s3/>Amazon S3</a> Event Notifications for the bucket, selecting to send notifications to <a href=https://aws.amazon.com/eventbridge/>Amazon EventBridge</a>. You can enable this feature in the Properties tab of the bucket.</p><p><img alt="Enable sending notifications to EventBridge from S3 bucket" src=../../images/3-BlogsTranslated/3.3-Blog3/s3-eventbridge.jpg></p><p><em>Figure 2: Enable sending notifications to EventBridge from S3 bucket</em></p><hr><h2 id=deployment-steps>Deployment steps</h2><p><img alt="Solution architecture" src=../../images/3-BlogsTranslated/3.3-Blog3/arch-diagram.jpg></p><p><em>Figure 3: Solution architecture</em></p><hr><h2 id=building-image-building-pipeline-with-ec2-image-builder>Building Image Building Pipeline with EC2 Image Builder</h2><p>This solution uses the following AWS services:</p><ul><li><p><strong><a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a></strong>: runs LBK from <a href=https://aws.amazon.com/s3/>Amazon S3</a> to harden and package the AMI. <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> uses AWS Task Orchestrator and Executor (<a href=https://docs.aws.amazon.com/imagebuilder/latest/userguide/toe-component-manager.html>AWSTOE</a>) to orchestrate complex workflows. You will create a <a href=https://docs.aws.amazon.com/imagebuilder/latest/userguide/create-custom-components.html>custom component</a> to call LBK from S3, while defining an image recipe as the base image and an <a href=https://docs.aws.amazon.com/imagebuilder/latest/userguide/manage-image-workflows.html>image workflow</a> that defines the sequence of build steps.</p></li><li><p><strong><a href=https://aws.amazon.com/inspector/>Amazon Inspector</a></strong>: performs security checks (CIS scan) to validate the AMI after hardening.</p></li><li><p><strong><a href=https://aws.amazon.com/eventbridge/>Amazon EventBridge</a></strong>: integrates natively with <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> and S3 to emit events. These events can be forwarded to <a href=https://aws.amazon.com/sns/>Amazon SNS</a> or <a href=https://aws.amazon.com/lambda/>AWS Lambda</a>.</p></li><li><p><strong><a href=https://aws.amazon.com/sns/>Amazon SNS</a></strong>: used to send email notifications about approval steps.</p></li></ul><h3 id=create-custom-component-for-ec2-image-builder>Create custom Component for EC2 Image Builder</h3><p>You can use an <a href=https://aws.amazon.com/cloudformation/>AWS CloudFormation</a> template (provided in the original post) to initialize a stack that creates all resources mentioned in the sections below.</p><p>Example command to deploy the stack:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws cloudformation create-stack --stack-name cis-al2-harden-stack <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--template-body file://cis-lbk-automation-template.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--parameters
</span></span></code></pre></div><p>This CloudFormation template will automatically create the components described in the solution architecture.</p><p>In this post, we define a <a href=https://docs.aws.amazon.com/imagebuilder/latest/userguide/create-custom-components.html>custom component</a> named <strong>CIS-AL2-L1S-Hardening</strong>, with the following characteristics:</p><ul><li><strong>Type</strong>: build</li><li><strong>Platform</strong>: Linux and compatible operating systems</li><li><strong>OS Version</strong>: <a href=https://aws.amazon.com/amazon-linux-2/>Amazon Linux 2</a></li></ul><p>Each component is defined by a YAML document, where the S3 bucket created in the prerequisite step is used to download scripts and upload logs. The following table lists a series of steps in the build phase.</p><p><img alt="Build phase steps" src=../../images/3-BlogsTranslated/3.3-Blog3/workflow-steps.jpg></p><p><em>Figure 4: Build phase steps</em></p><p>Example component definition:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;CIS-Build-AL2-Level1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>description</span>: <span style=color:#e6db74>&#39;Applies the L1S CIS settings for Amazon Linux 2 (AL2)&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>schemaVersion</span>: <span style=color:#ae81ff>1.0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>parameters</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>StagingS3BucketName</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>FileName</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>default</span>: <span style=color:#e6db74>&#39;amazon_linux_2.tar.gz&#39;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>Version</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>default</span>: <span style=color:#e6db74>&#39;2024.2.0&#39;</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>Level</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>string</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>default</span>: <span style=color:#e6db74>&#39;L1S&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>phases</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>OperatingSystemRelease</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ExecuteBash</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>            - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                FILE=/etc/os-release
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                if [ -e $FILE ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                . $FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                echo &#34;$ID${VERSION_ID:+.${VERSION_ID}}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                echo &#34;The file $FILE does not exist. Exiting.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                fi</span>                
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>GetPackageManager</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ExecuteBash</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>            - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                RELEASE=&#39;{{build.OperatingSystemRelease.outputs.stdout}}&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                case &#34;${RELEASE}&#34; in
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                amzn*|centos*|rhel*)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    echo &#39;yum&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    ;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ubuntu*)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    echo &#39;apt&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    ;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                *)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    echo &#34;Operating System &#39;${RELEASE}&#39; is not supported. Exiting.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    ;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                esac</span>                
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>VerifyPrerequisite</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ExecuteBash</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Abort</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>            - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                INSTALL_TYPE=&#39;{{build.GetPackageManager.outputs.stdout}}&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                case &#34;${INSTALL_TYPE}&#34; in
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &#39;yum&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    if ! yum -q list installed tar &amp;&gt;/dev/null; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    yum install -q -y tar
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    echo &#34;Installed tar.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    echo &#34;Tar is already installed.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    ;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                &#39;apt&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    apt install -q -y tar
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    echo &#34;Installed tar.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    ;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                *)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    echo &#34;Install type &#39;${INSTALL_TYPE}&#39; is not supported at this time. Exiting.&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    ;;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                esac</span>                
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>MakeStagingDIR</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ExecuteBash</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>            - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                mkdir cis-stage
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                cd cis-stage
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                pwd</span>                
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>SettingStagingDirPermissions</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>action</span>: <span style=color:#ae81ff>SetFolderPermissions</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#39;{{build.MakeStagingDIR.outputs.stdout}}&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>permissions</span>: <span style=color:#ae81ff>0700</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Download_CIS_LBK</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>action</span>: <span style=color:#ae81ff>S3Download</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>source</span>: <span style=color:#ae81ff>s3://{{ StagingS3BucketName }}/{{ FileName }}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>destination</span>: <span style=color:#e6db74>&#39;{{build.MakeStagingDIR.outputs.stdout}}/{{ FileName }}&#39;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Unzip_CIS_LBK</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ExecuteBash</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Continue</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ae81ff>sudo tar -xvf &#39;{{build.MakeStagingDIR.outputs.stdout}}/{{ FileName }}&#39; -C &#39;{{build.MakeStagingDIR.outputs.stdout}}/&#39; || ( echo &#34;File extraction failed. Exiting&#34; ; exit 1; )</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>AL2_ConfigureCIS</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ExecuteBash</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Continue</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>            - |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                RELEASE=&#39;{{ build.OperatingSystemRelease.outputs.stdout }}&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                if [ ! `echo &#34;$RELEASE&#34; | grep -E &#34;^(amzn\.2$|(centos|rhel)\.7)&#34;` ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                echo &#39;Skipping this step for the current operating system.&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                exit 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                cd {{build.MakeStagingDIR.outputs.stdout}}/CIS-LBK/cis_lbk_amazon_linux_2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                sudo ./amazon_linux_2.sh || ( echo &#34;CIS configuration script failed to run. Exiting.&#34; ; exit 1; )</span>                
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>UploadLogFiles</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>action</span>: <span style=color:#ae81ff>S3Upload</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Abort</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>maxAttempts</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>source</span>: <span style=color:#e6db74>&#39;{{build.MakeStagingDIR.outputs.stdout}}/CIS-LBK/cis_lbk_amazon_linux_2/logs/*&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>destination</span>: <span style=color:#e6db74>&#39;s3://{{ StagingS3BucketName }}/logs/&#39;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>recurse</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>expectedBucketOwner</span>: <span style=color:#ae81ff>&lt;&lt;your account number&gt;&gt;</span>
</span></span></code></pre></div><h3 id=create-image-recipe-based-on-component>Create Image Recipe based on Component</h3><p>An Image Recipe is a document that defines the <strong>components</strong> applied to a <strong>base image</strong> to create the desired configuration for the <strong>output image</strong>.</p><p>The recipe named <strong>CIS-AL2-L1S-Hardening-Recipe</strong> is created using the <strong>custom component CIS-AL2-L1S-Hardening</strong> as the main build phase.</p><p><strong>Sample AWS CloudFormation template</strong> is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>ImageRecipeCISAL2L1S</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Type</span>: <span style=color:#e6db74>&#34;AWS::ImageBuilder::ImageRecipe&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Components</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>ComponentArn</span>: !<span style=color:#ae81ff>GetAtt CISAL2HardeningComponent.Arn</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Parameters</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>Value</span>:
</span></span><span style=display:flex><span>        - !<span style=color:#ae81ff>Sub &#34;${StagingS3BucketName}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>Name</span>: <span style=color:#e6db74>&#34;StagingS3BucketName&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>WorkingDirectory</span>: <span style=color:#e6db74>&#34;/var/tmp&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ParentImage</span>: !<span style=color:#ae81ff>Sub &#34;arn:aws:imagebuilder:${AWS::Region}:aws:image/amazon-linux-2-x86/x.x.x&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>AdditionalInstanceConfiguration</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>SystemsManagerAgent</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>UninstallAfterBuild</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Name</span>: <span style=color:#e6db74>&#34;CIS-AL2-L1S-Hardening&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>DependsOn</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>CISAL2HardeningComponent</span>
</span></span></code></pre></div><p>As you can see, the <strong>custom component (<a href=https://docs.aws.amazon.com/imagebuilder/latest/userguide/create-custom-components.html>custom component</a>)</strong> is referenced in the recipe, while the recipe also references the <strong>latest version of <a href=https://aws.amazon.com/amazon-linux-2/>Amazon Linux 2</a></strong> as the <strong>base image</strong> through the ParentImage property.</p><p>The <strong>CIS-AL2-L1S-Hardening</strong> component takes <strong>WorkingDirectory</strong> as input.</p><div class="notices note"><p>This value must be set to <code>/var/tmp</code>, because the default <code>/tmp</code> directory will have its permissions changed by the CIS LBK script, causing access errors when running.</p></div><h3 id=create-custom-workflow-for-image-build-process>Create custom Workflow for Image Build process</h3><p><strong>Image Workflow</strong> defines the sequence of steps <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> performs during the <strong>build</strong> and <strong>test</strong> phases of the image creation process.</p><p>This workflow introduces the <strong>WaitForAction</strong> action, which adds a <strong>manual approval</strong> step after the hardening process completes. At this step, operators can review logs and continue creating the image. This is also when you can trigger and view <strong><a href=https://aws.amazon.com/inspector/>Amazon Inspector</a> scan</strong> results.</p><p>The <strong>WaitForAction</strong> action pauses the running workflow and waits for a response from the <strong>SendWorkflowStepAction</strong> API of <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a>. This event emits an <strong>EventBridge event</strong> with detail-type &ldquo;<a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> Workflow Step Waiting&rdquo;.</p><p>For this blog post, the authors create a <strong>custom workflow</strong> named <strong>build-cis-hardened-manual-action</strong>, type <strong>BUILD</strong>, with the following YAML content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>build-cis-hardened-manual-action</span>
</span></span><span style=display:flex><span><span style=color:#f92672>description</span>: <span style=color:#ae81ff>Workflow to build an AMI</span>
</span></span><span style=display:flex><span><span style=color:#f92672>schemaVersion</span>: <span style=color:#ae81ff>1.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>LaunchBuildInstance</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>LaunchInstance</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Abort</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>waitFor</span>: <span style=color:#e6db74>&#34;ssmAgent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ApplyBuildComponents</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>ExecuteComponents</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Abort</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>instanceId.$</span>: <span style=color:#e6db74>&#34;$.stepOutputs.LaunchBuildInstance.instanceId&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>InventoryCollection</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>CollectImageMetadata</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Abort</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>and</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>stringEquals</span>: <span style=color:#e6db74>&#34;AMI&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;$.imagebuilder.imageType&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>booleanEquals</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;$.imagebuilder.collectImageMetadata&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>instanceId.$</span>: <span style=color:#e6db74>&#34;$.stepOutputs.LaunchBuildInstance.instanceId&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>RunSanitizeScript</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>SanitizeInstance</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Abort</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>and</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>stringEquals</span>: <span style=color:#e6db74>&#34;AMI&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;$.imagebuilder.imageType&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>stringEquals</span>: <span style=color:#e6db74>&#34;Linux&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;$.imagebuilder.platform&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>instanceId.$</span>: <span style=color:#e6db74>&#34;$.stepOutputs.LaunchBuildInstance.instanceId&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>CheckBuildLogsAndApprove</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>WaitForAction</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>CreateOutputAMI</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>CreateImage</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Abort</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>if</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>stringEquals</span>: <span style=color:#e6db74>&#34;AMI&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;$.imagebuilder.imageType&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>instanceId.$</span>: <span style=color:#e6db74>&#34;$.stepOutputs.LaunchBuildInstance.instanceId&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>TerminateBuildInstance</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>action</span>: <span style=color:#ae81ff>TerminateInstance</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>onFailure</span>: <span style=color:#ae81ff>Continue</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>instanceId.$</span>: <span style=color:#e6db74>&#34;$.stepOutputs.LaunchBuildInstance.instanceId&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>outputs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;ImageId&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;$.stepOutputs.CreateOutputAMI.imageId&#34;</span>
</span></span></code></pre></div><h3 id=create-image-pipeline>Create Image Pipeline</h3><p>In the blog example, the authors create an <strong>Image Pipeline</strong> named <strong>CIS-AL2-L1S-Hardening-pipeline</strong>.</p><p><a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> uses <strong><a href=https://aws.amazon.com/inspector/>Amazon Inspector</a></strong> to scan test instances for security vulnerabilities in the operating system or software packages. However, in this case, the default vulnerability scanning feature is <strong>disabled</strong>, as the team only uses <a href=https://aws.amazon.com/inspector/>Amazon Inspector</a> to <strong>perform CIS scan</strong> on the <strong>output image</strong>, not general vulnerability scanning.</p><p>The <strong>Build Schedule</strong> is set to <strong>Manual</strong> mode. You can schedule it periodically using <strong>Schedule Builder (CRON expression)</strong>.</p><p>Next, the team selects the <strong>Image Recipe (CIS-AL2-L1S-Hardening-Recipe)</strong> created in the previous step. The image creation process is defined using a <strong>Custom Workflow</strong>, where <strong>build-cis-hardened-manual-action</strong> is selected as the <strong>Build workflow</strong>.</p><p>The IAM Role selected is <strong>AWSServiceRoleForImageBuilder</strong>, which provides the necessary access for <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a>.</p><p>The Infrastructure Configuration is kept at default, except for adding a <strong>Resource Tag</strong> for the instance:</p><ul><li><strong>Key</strong>: <code>IBCISHardened</code></li><li><strong>Value</strong>: <code>Yes</code></li></ul><p>→ This tag is used in the <a href=https://aws.amazon.com/inspector/>Amazon Inspector</a> configuration as a filter criterion for CIS scanning.</p><p><strong>Distribution Settings</strong> are kept at default – meaning <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> will launch instances in the <strong>default VPC</strong>, and <strong>distribute the output AMI</strong> in the <strong>current Region</strong>.</p><p>This <strong>Infrastructure Configuration</strong> section creates the IAM Role and Instance Profile used by the build instance to configure the AMI. This Instance Role is attached to <strong>EC2InstanceProfileForImageBuilder</strong> and <strong>AmazonSSMManagedInstanceCore managed policy</strong>.</p><p>To successfully run <strong><a href=https://aws.amazon.com/inspector/>Amazon Inspector</a> CIS scan</strong>, the <strong>Instance Profile</strong> needs to attach the additional policy <strong>AmazonInspector2ManagedCisPolicy</strong>.</p><p>The IAM Instance Profile Role configuration is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>IAMManagedPolicyIBCisComponentS3Access</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Type</span>: <span style=color:#e6db74>&#34;AWS::IAM::ManagedPolicy&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ManagedPolicyName</span>: <span style=color:#e6db74>&#34;IBCisComponentS3Access&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Path</span>: <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Description</span>: <span style=color:#e6db74>&#34;Access to S3 Bucket from EC2 ImageBuilder CIS Custom component&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>PolicyDocument</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Statement</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>Resource</span>: <span style=color:#e6db74>&#34;arn:aws:s3:::cis-lbk-al2/*&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;s3:PutObject&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;s3:GetObject&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>Effect</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>IAMRoleForImageBuilderCISAL2</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Type</span>: <span style=color:#e6db74>&#34;AWS::IAM::Role&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ManagedPolicyArns</span>:
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;arn:aws:iam::aws:policy/EC2InstanceProfileForImageBuilder&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>Ref</span>: <span style=color:#e6db74>&#34;IAMManagedPolicyIBCisComponentS3Access&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;arn:aws:iam::aws:policy/AmazonInspector2ManagedCisPolicy&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>AssumeRolePolicyDocument</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Statement</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>Action</span>: <span style=color:#e6db74>&#34;sts:AssumeRole&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>Effect</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>Principal</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>Service</span>: <span style=color:#e6db74>&#34;ec2.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>EC2InstanceProfileForImageBuilderCISAL2</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Type</span>: <span style=color:#e6db74>&#34;AWS::IAM::InstanceProfile&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Roles</span>:
</span></span><span style=display:flex><span>    - !<span style=color:#ae81ff>Ref &#34;IAMRoleForImageBuilderCISAL2&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>InstanceProfileName</span>: <span style=color:#e6db74>&#34;EC2InstanceProfileForImageBuilderCISAL2&#34;</span>
</span></span></code></pre></div><h3 id=attach-bucket-policy-to-s3-bucket-cis-lbk-al2>Attach Bucket Policy to S3 Bucket cis-lbk-al2</h3><p>This policy only allows the IAM Role of the Instance Profile to access the bucket:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Sid&#34;</span>: <span style=color:#e6db74>&#34;Statement1&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Principal&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;AWS&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:iam::7284282*****:role/IAMRoleForImageBuilderCISAL2&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;s3:PutObject&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;Resource&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:s3:::cis-lbk-al2&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=create-amazon-sns-topic-for-email-notification>Create Amazon SNS Topic for Email Notification</h3><p>The team creates an <strong>SNS Topic</strong> named <code>ImageBuilderQueue</code>, along with an <strong>Email Subscription</strong> to send notifications to the person responsible for the process.</p><h3 id=create-amazon-eventbridge-rules-to-send-notifications>Create Amazon EventBridge Rules to send notifications</h3><p>Two <strong>EventBridge rules</strong> are created to send notifications via SNS:</p><p><strong>Rule 1 – Notification when workflow is waiting for approval (WaitForAction):</strong></p><p>When <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> emits a &ldquo;Workflow Step Waiting&rdquo; event for the <strong>CheckBuildLogsAndApprove</strong> step, this rule sends a message to the SNS Topic <code>ImageBuilderQueue</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>AWSTemplateFormatVersion</span>: <span style=color:#e6db74>&#39;2010-09-09&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Description</span>: <span style=color:#ae81ff>CloudFormation template for EventBridge Rule ec2-imagebuilder</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Resources</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Rule41742a2e</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::Events::Rule</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Name</span>: <span style=color:#ae81ff>ec2-imagebuilder</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>EventPattern</span>: &gt;-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {&#34;source&#34;:[&#34;aws.imagebuilder&#34;],&#34;detail-type&#34;:[&#34;EC2 Image Builder Workflow Step Waiting&#34;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         &#34;detail&#34;:{&#34;workflow-step-name&#34;:[&#34;CheckBuildLogsAndApprove&#34;]}}</span>        
</span></span><span style=display:flex><span>      <span style=color:#f92672>State</span>: <span style=color:#ae81ff>ENABLED</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>EventBusName</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Targets</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>Arn</span>: !<span style=color:#ae81ff>Sub &#34;arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:ImageBuilderQueue&#34;</span>
</span></span></code></pre></div><p><strong>Rule 2 – Notification when CIS log is created in S3 bucket:</strong></p><p>When a <code>CIS-LBK.log</code> object is created in the <code>/logs/.../</code> path, EventBridge sends a notification to the SNS topic <code>ImageBuilderQueue</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>AWSTemplateFormatVersion</span>: <span style=color:#e6db74>&#39;2010-09-09&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Description</span>: <span style=color:#ae81ff>CloudFormation template for EventBridge Rule CISHardeningExitLogEvent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Resources</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Rule104d463b</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::Events::Rule</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Name</span>: <span style=color:#ae81ff>CISHardeningExitLogEvent</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>EventPattern</span>: &gt;-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {&#34;source&#34;:[&#34;aws.s3&#34;],&#34;detail-type&#34;:[&#34;Object Created&#34;],
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         &#34;detail&#34;:{&#34;bucket&#34;:{&#34;name&#34;:[&#34;cis-lbk-al2&#34;]},
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         &#34;object&#34;:{&#34;key&#34;:[{&#34;wildcard&#34;:&#34;logs/*CIS-LBK.log&#34;}]}}}</span>        
</span></span><span style=display:flex><span>      <span style=color:#f92672>State</span>: <span style=color:#ae81ff>ENABLED</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>EventBusName</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Targets</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>Arn</span>: !<span style=color:#ae81ff>Sub &#34;arn:${AWS::Partition}:sns:${AWS::Region}:${AWS::AccountId}:ImageBuilderQueue&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>InputTransformer</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>InputPathsMap</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>bucketname</span>: <span style=color:#ae81ff>$.detail.bucket.name</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>objectkey</span>: <span style=color:#ae81ff>$.detail.object.key</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>region</span>: <span style=color:#ae81ff>$.region</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>InputTemplate</span>: &gt;-<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &#34;Review the output log for the CIS Hardening process in &lt;bucketname&gt; bucket at &lt;objectkey&gt;.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               Log URL: https://&lt;bucketname&gt;.s3.&lt;region&gt;.amazonaws.com/&lt;objectkey&gt;&#34;</span>              
</span></span></code></pre></div><h3 id=run-image-pipeline>Run Image Pipeline</h3><p>You can launch the pipeline from <strong>AWS Console</strong> or <strong><a href=https://aws.amazon.com/cli/>AWS CLI</a></strong>.</p><p>Sample CLI command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws imagebuilder start-image-pipeline-execution <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--image-pipeline-arn arn:aws:imagebuilder:<span style=color:#f92672>{</span>REGION<span style=color:#f92672>}</span>:<span style=color:#f92672>{</span>ACCOUNT_ID<span style=color:#f92672>}</span>:image-pipeline/CIS-AL2-L1S-Hardening-pipeline
</span></span></code></pre></div><p>Response:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;requestId&#34;</span>: <span style=color:#e6db74>&#34;a1b2c3d4-5678-90ab-cdef-EXAMPLE11111&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;clientToken&#34;</span>: <span style=color:#e6db74>&#34;a1b2c3d4-5678-90ab-cdef-EXAMPLE22222&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;imageBuildVersionArn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:imagebuilder:{REGION}:{ACCOUNT_ID}:image/cis-al2-l1s-hardening/1.0.1/1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Note the <code>imageBuildVersionArn</code> and <code>stepExecutionId</code>. The pipeline will <strong>pause</strong> at the <code>CheckBuildLogsAndApprove</code> step.</p><p>Check the waiting status with the command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws imagebuilder list-waiting-workflow-step
</span></span></code></pre></div><p>When running successfully, you will receive <strong>2 email notifications</strong>:</p><ul><li>One email from <strong>S3 EventBridge</strong> containing the CIS-LBK log file link.</li><li>One email from <strong>Image Builder</strong> requesting approval for the waiting step.</li></ul><p>Example log notification content:</p><pre tabindex=0><code>&#34;Review the output log for the CIS Hardening process in &#39;cis-lbk-al2&#39; bucket, location &#39;logs/08_27_2024_1210/CIS-LBK.log&#39;...&#34;
</code></pre><hr><h2 id=testing-image-with-amazon-inspector>Testing Image with Amazon Inspector</h2><p>During the waiting phase, you create a <strong>one-time CIS scan</strong> using <a href=https://aws.amazon.com/inspector/>Amazon Inspector</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws inspector2 create-cis-scan-configuration <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--scan-name cis-hardened-scan <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--schedule oneTime<span style=color:#f92672>={}</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--security-level <span style=color:#e6db74>&#34;LEVEL_1&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--targets <span style=color:#e6db74>&#34;accountIds=&lt;&lt;account_id&gt;&gt;,targetResourceTags={IBCISHardened=Yes}&#34;</span>
</span></span></code></pre></div><p>Monitor scan progress:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws inspector2 list-cis-scans <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--filter-criteria <span style=color:#e6db74>&#34;scanConfigurationArnFilters=[{comparison=EQUALS,value=&lt;&lt;scanConfigurationArn&gt;&gt;}]&#34;</span>
</span></span></code></pre></div><p>After completion, download the <strong>PDF report</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws inspector2 get-cis-scan-report --scan-arn &lt;&lt;scan-arn&gt;&gt; --report-format PDF
</span></span></code></pre></div><p>The result returns the URL of the report, which can be opened in a browser logged into AWS.</p><h3 id=continue-or-stop-workflow>Continue or stop workflow</h3><p>After reviewing logs and reports:</p><p><strong>Continue pipeline:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws imagebuilder send-workflow-step-action <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--step-execution-id <span style=color:#e6db74>&lt;&lt;stepExecutionId&gt;&gt; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--image-build-vers</span>ion-arn <span style=color:#e6db74>&lt;&lt;imageBui</span>ldVersionArn&gt;&gt; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--action RESUME
</span></span></code></pre></div><p><strong>Or stop pipeline:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws imagebuilder send-workflow-step-action <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--step-execution-id <span style=color:#e6db74>&lt;&lt;stepExecutionId&gt;&gt; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--image-build-vers</span>ion-arn <span style=color:#e6db74>&lt;&lt;imageBui</span>ldVersionArn&gt;&gt; <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--action STOP <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--reason <span style=color:#e6db74>&#34;Please fix the issue and recreate the Image&#34;</span>
</span></span></code></pre></div><p>When complete, view the output AMI:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws imagebuilder get-image <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--image-build-version-arn <span style=color:#e6db74>&lt;&lt;imageBuildVersionArn&gt;&gt; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--query &#39;image</span>.outputResources.amis<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>.image<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span></code></pre></div><hr><h2 id=conclusion>Conclusion</h2><p>In this post, we set up a process based on <a href=https://aws.amazon.com/image-builder/>EC2 Image Builder</a> to harden an <a href=https://aws.amazon.com/amazon-linux-2/>Amazon Linux 2</a> AMI according to the CIS <a href=https://aws.amazon.com/amazon-linux-2/>Amazon Linux 2</a> Benchmark using the CIS Linux Build Kit provided by the CIS community.</p><p>We also leveraged event-based notifications from <a href=https://aws.amazon.com/s3/>Amazon S3</a> and <a href=https://aws.amazon.com/eventbridge/>Amazon EventBridge</a> to trigger approval emails and introduce a manual approval process.</p><p>This framework can be extended to harden other AMIs such as <strong>Ubuntu</strong> or <strong>CentOS</strong>, using the corresponding LBK kits from the CIS community.</p><p>Contact your <a href=https://aws.amazon.com/contact-us/sales-support-cloudops/>AWS representative</a> for support in implementing this process for your organization.</p><hr><h2 id=further-reading>Further reading</h2><ul><li><a href=https://docs.aws.amazon.com/imagebuilder/latest/userguide/toe-cis.html>CIS hardening components for EC2 Image Builder</a></li><li><a href=https://aws.amazon.com/blogs/containers/build-a-pipeline-for-hardened-container-images-using-ec2-image-builder-and-terraform/>Build a pipeline for hardened container images using EC2 Image Builder and Terraform</a></li><li><a href=https://docs.aws.amazon.com/inspector/latest/user/inspector_best_practices.html>Amazon Inspector Best Practices</a></li></ul><hr><h2 id=about-the-author>About the author</h2><p><strong>Rajat Chatterjee</strong></p><p>Rajat is a Senior Solutions Architect, working with customers in the Financial Services sector including Banking, Insurance, and Capital Markets, helping them build reliable, secure, and high-performance applications on the cloud.</p><p>He has expertise in large-scale deployments of microservices-based workloads on container platforms for enterprises.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=../../3-blogstranslated/3.2-blog2/ title="Build end-to-end Apache Spark pipelines with Amazon MWAA, Batch Processing Gateway, and Amazon EMR on EKS"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=../../4-eventparticipated/ title="Events Participated" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=../../js/clipboard.min.js?1765512673></script><script src=../../js/perfect-scrollbar.min.js?1765512673></script><script src=../../js/perfect-scrollbar.jquery.min.js?1765512673></script><script src=../../js/jquery.sticky.js?1765512673></script><script src=../../js/featherlight.min.js?1765512673></script><script src=../../js/highlight.pack.js?1765512673></script><script>hljs.initHighlightingOnLoad()</script><script src=../../js/modernizr.custom-3.6.0.js?1765512673></script><script src=../../js/learn.js?1765512673></script><script src=../../js/hugo-learn.js?1765512673></script><link href=../../mermaid/mermaid.css?1765512673 rel=stylesheet><script src=../../mermaid/mermaid.js?1765512673></script><script>mermaid.initialize({startOnLoad:!0})</script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,(e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date),(i=t.createElement(n),a=t.getElementsByTagName(n)[0]),i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-158079754-2","auto"),ga("send","pageview")</script></body></html>