<!doctype html><html lang=vi class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.134.3"><meta name=description content><meta name=author content="phuctptse183992@fpt.edu.vn"><link rel=icon href=../../../images/favicon.png type=image/png><title>Xây dựng pipeline Apache Spark end-to-end với Amazon MWAA, Batch Processing Gateway và Amazon EMR trên EKS :: Báo cáo thực tập</title>
<link href=../../../css/nucleus.css?1765512673 rel=stylesheet><link href=../../../css/fontawesome-all.min.css?1765512673 rel=stylesheet><link href=../../../css/hybrid.css?1765512673 rel=stylesheet><link href=../../../css/featherlight.min.css?1765512673 rel=stylesheet><link href=../../../css/perfect-scrollbar.min.css?1765512673 rel=stylesheet><link href=../../../css/auto-complete.css?1765512673 rel=stylesheet><link href=../../../css/atom-one-dark-reasonable.css?1765512673 rel=stylesheet><link href=../../../css/theme.css?1765512673 rel=stylesheet><link href=../../../css/hugo-theme.css?1765512673 rel=stylesheet><link href=../../../css/theme-workshop.css?1765512673 rel=stylesheet><script src=../../../js/jquery-3.3.1.min.js?1765512673></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=../../../vi/3-blogstranslated/3.2-blog2/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=../../../><svg id="Layer_1" data-name="Layer 1" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff}.cls-2{fill:#f90;fill-rule:evenodd}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09 10.85a4.7 4.7.0 00.19 1.48 7.73 7.73.0 00.54 1.19.77.77.0 01.12.38.64.64.0 01-.32.49l-1 .7a.83.83.0 01-.44.15.69.69.0 01-.49-.23 3.8 3.8.0 01-.6-.77q-.25-.42-.51-1a6.14 6.14.0 01-4.89 2.3 4.54 4.54.0 01-3.32-1.19 4.27 4.27.0 01-1.22-3.2 4.28 4.28.0 011.46-3.4A6.06 6.06.0 017.69 6.46a12.47 12.47.0 011.76.13q.92.13 1.91.36V5.73a3.65 3.65.0 00-.79-2.66A3.81 3.81.0 007.86 2.3a7.71 7.71.0 00-1.79.22 12.78 12.78.0 00-1.79.57 4.55 4.55.0 01-.58.22h-.26q-.35.0-.35-.52V2a1.09 1.09.0 01.12-.58 1.2 1.2.0 01.47-.35A10.88 10.88.0 015.77.32 10.19 10.19.0 018.36.0a6 6 0 014.35 1.35 5.49 5.49.0 011.38 4.09zM7.34 13.38a5.36 5.36.0 001.72-.31A3.63 3.63.0 0010.63 12 2.62 2.62.0 0011.19 11a5.63 5.63.0 00.16-1.44v-.7a14.35 14.35.0 00-1.53-.28 12.37 12.37.0 00-1.56-.1 3.84 3.84.0 00-2.47.67A2.34 2.34.0 005 11a2.35 2.35.0 00.61 1.76A2.4 2.4.0 007.34 13.38zm13.35 1.8a1 1 0 01-.64-.16 1.3 1.3.0 01-.35-.65L15.81 1.51a3 3 0 01-.15-.67.36.36.0 01.41-.41H17.7a1 1 0 01.65.16 1.4 1.4.0 01.33.65l2.79 11 2.59-11A1.17 1.17.0 0124.39.6a1.1 1.1.0 01.67-.16H26.4a1.1 1.1.0 01.67.16 1.17 1.17.0 01.32.65L30 12.39 32.88 1.25A1.39 1.39.0 0133.22.6a1 1 0 01.65-.16h1.54a.36.36.0 01.41.41 1.36 1.36.0 010 .26 3.64 3.64.0 01-.12.41l-4 12.86a1.3 1.3.0 01-.35.65 1 1 0 01-.64.16H29.25a1 1 0 01-.67-.17 1.26 1.26.0 01-.32-.67L25.67 3.64l-2.56 10.7a1.26 1.26.0 01-.32.67 1 1 0 01-.67.17zm21.36.44a11.28 11.28.0 01-2.56-.29 7.44 7.44.0 01-1.92-.67 1 1 0 01-.61-.93v-.84q0-.52.38-.52a.9.9.0 01.31.06l.42.17a8.77 8.77.0 001.83.58 9.78 9.78.0 002 .2 4.48 4.48.0 002.43-.55 1.76 1.76.0 00.86-1.57 1.61 1.61.0 00-.45-1.16A4.29 4.29.0 0043 9.22l-2.41-.76A5.15 5.15.0 0138 6.78a3.94 3.94.0 01-.83-2.41 3.7 3.7.0 01.45-1.85 4.47 4.47.0 011.19-1.37 5.27 5.27.0 011.7-.86A7.4 7.4.0 0142.6.0a8.87 8.87.0 011.12.07q.57.07 1.08.19t.95.26a4.27 4.27.0 01.7.29 1.59 1.59.0 01.49.41.94.94.0 01.15.55v.79q0 .52-.38.52a1.76 1.76.0 01-.64-.2 7.74 7.74.0 00-3.2-.64 4.37 4.37.0 00-2.21.47 1.6 1.6.0 00-.79 1.48 1.58 1.58.0 00.49 1.18 4.94 4.94.0 001.83.92L44.55 7a5.08 5.08.0 012.57 1.6A3.76 3.76.0 0147.9 11a4.21 4.21.0 01-.44 1.93 4.4 4.4.0 01-1.21 1.47 5.43 5.43.0 01-1.85.93A8.25 8.25.0 0142.05 15.62z"/><path class="cls-2" d="M45.19 23.81C39.72 27.85 31.78 30 25 30A36.64 36.64.0 01.22 20.57c-.51-.46-.06-1.09.56-.74A49.78 49.78.0 0025.53 26.4 49.23 49.23.0 0044.4 22.53C45.32 22.14 46.1 23.14 45.19 23.81z"/><path class="cls-2" d="M47.47 21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74 3.13-2.2 8.27-1.57 8.86-.83s-.16 5.89-3.09 8.35c-.45.38-.88.18-.68-.32C46.69 25.8 48.17 22.11 47.47 21.21z"/></svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=../../../js/lunr.min.js?1765512673></script><script type=text/javascript src=../../../js/auto-complete.js?1765512673></script><script type=text/javascript>var baseurl="https://crystaljohn.github.io/fcj-workshop//vi"</script><script type=text/javascript src=../../../js/search.js?1765512673></script></div><div class=highlightable><ul class=topics><li data-nav-id=/vi/1-worklog/ title="Nhật ký công việc" class=dd-item><a href=../../../vi/1-worklog/><b>1. </b>Nhật ký công việc
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/vi/1-worklog/1.1-week1/ title="Worklog Tuần 1" class=dd-item><a href=../../../vi/1-worklog/1.1-week1/><b>1.1. </b>Worklog Tuần 1
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.2-week2/ title="Worklog Tuần 2" class=dd-item><a href=../../../vi/1-worklog/1.2-week2/><b>1.2. </b>Worklog Tuần 2
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.3-week3/ title="Worklog Tuần 3" class=dd-item><a href=../../../vi/1-worklog/1.3-week3/><b>1.3. </b>Worklog Tuần 3
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.4-week4/ title="Worklog Tuần 4" class=dd-item><a href=../../../vi/1-worklog/1.4-week4/><b>1.4. </b>Worklog Tuần 4
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.5-week5/ title="Worklog Tuần 5" class=dd-item><a href=../../../vi/1-worklog/1.5-week5/><b>1.5. </b>Worklog Tuần 5
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.6-week6/ title="Worklog Tuần 6" class=dd-item><a href=../../../vi/1-worklog/1.6-week6/><b>1.6. </b>Worklog Tuần 6
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.7-week7/ title="Worklog Tuần 7" class=dd-item><a href=../../../vi/1-worklog/1.7-week7/><b>1.7. </b>Worklog Tuần 7
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.8-week8/ title="Worklog Tuần 8" class=dd-item><a href=../../../vi/1-worklog/1.8-week8/><b>1.8. </b>Worklog Tuần 8
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.9-week9/ title="Worklog Tuần 9" class=dd-item><a href=../../../vi/1-worklog/1.9-week9/><b>1.9. </b>Worklog Tuần 9
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.10-week10/ title="Worklog Tuần 10" class=dd-item><a href=../../../vi/1-worklog/1.10-week10/><b>1.10. </b>Worklog Tuần 10
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.11-week11/ title="Worklog Tuần 11" class=dd-item><a href=../../../vi/1-worklog/1.11-week11/><b>1.11. </b>Worklog Tuần 11
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/1-worklog/1.12-week12/ title="Worklog Tuần 12" class=dd-item><a href=../../../vi/1-worklog/1.12-week12/><b>1.12 </b>Worklog Tuần 12
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/vi/2-proposal/ title="Bản đề xuất" class=dd-item><a href=../../../vi/2-proposal/><b>2. </b>Bản đề xuất
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/3-blogstranslated/ title="Các Blog Đã Dịch" class="dd-item
parent"><a href=../../../vi/3-blogstranslated/><b>3. </b>Các Blog Đã Dịch
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/vi/3-blogstranslated/3.1-blog1/ title="Xây dựng nhà khí tượng ảo bằng Amazon Bedrock Agents" class=dd-item><a href=../../../vi/3-blogstranslated/3.1-blog1/><b>3.1. </b>Xây dựng nhà khí tượng ảo bằng Amazon Bedrock Agents
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/3-blogstranslated/3.2-blog2/ title="Xây dựng pipeline Apache Spark end-to-end với Amazon MWAA, Batch Processing Gateway và Amazon EMR trên EKS" class="dd-item
active"><a href=../../../vi/3-blogstranslated/3.2-blog2/><b>3.2. </b>Xây dựng pipeline Apache Spark end-to-end với Amazon MWAA, Batch Processing Gateway và Amazon EMR trên EKS
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/3-blogstranslated/3.3-blog3/ title="Xây dựng Golden Image với CIS Linux Build Kit trong Amazon EC2 Image Builder" class=dd-item><a href=../../../vi/3-blogstranslated/3.3-blog3/><b>3.3. </b>Xây dựng Golden Image với CIS Linux Build Kit trong Amazon EC2 Image Builder
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/vi/4-eventparticipated/ title="Các events đã tham gia" class=dd-item><a href=../../../vi/4-eventparticipated/><b>4. </b>Các events đã tham gia
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/vi/4-eventparticipated/4.1-event1/ title="Event 1" class=dd-item><a href=../../../vi/4-eventparticipated/4.1-event1/><b>4.1. </b>Event 1
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/4-eventparticipated/4.2-event2/ title="Event 2" class=dd-item><a href=../../../vi/4-eventparticipated/4.2-event2/><b>4.2. </b>Event 2
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/4-eventparticipated/4.3-event3/ title="Event 3" class=dd-item><a href=../../../vi/4-eventparticipated/4.3-event3/><b>4.2. </b>Event 3
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/4-eventparticipated/4.4-event4/ title="Event 4" class=dd-item><a href=../../../vi/4-eventparticipated/4.4-event4/><b>4.2. </b>Event 4
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/vi/5-workshop/ title=Workshop class=dd-item><a href=../../../vi/5-workshop/><b>5. </b>Workshop
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/vi/5-workshop/1-introduction/ title="Giới thiệu" class=dd-item><a href=../../../vi/5-workshop/1-introduction/><b>1. </b>Giới thiệu
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/2-preparation/ title="Các bước chuẩn bị" class=dd-item><a href=../../../vi/5-workshop/2-preparation/><b>2. </b>Các bước chuẩn bị
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/3-bedrock-models/ title="Kích hoạt Bedrock Models" class=dd-item><a href=../../../vi/5-workshop/3-bedrock-models/><b>3. </b>Kích hoạt Bedrock Models
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/4-aws-cli/ title="Cấu hình AWS CLI" class=dd-item><a href=../../../vi/5-workshop/4-aws-cli/><b>4. </b>Cấu hình AWS CLI
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/5-data-preparation/ title="Chuẩn bị Dữ liệu" class=dd-item><a href=../../../vi/5-workshop/5-data-preparation/><b>5. </b>Chuẩn bị Dữ liệu
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/6-infrastructure/ title="Triển khai giải pháp" class=dd-item><a href=../../../vi/5-workshop/6-infrastructure/><b>6. </b>Triển khai giải pháp
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/7-backend/ title="Thiết lập Backend API" class=dd-item><a href=../../../vi/5-workshop/7-backend/><b>7. </b>Thiết lập Backend API
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/8-idp-pipeline/ title="Thiết lập IDP Pipeline" class=dd-item><a href=../../../vi/5-workshop/8-idp-pipeline/><b>8. </b>Thiết lập IDP Pipeline
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/9-frontend/ title="Thiết lập Frontend" class=dd-item><a href=../../../vi/5-workshop/9-frontend/><b>9. </b>Thiết lập Frontend
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/10-using-chatbot/ title="Sử dụng Chatbot" class=dd-item><a href=../../../vi/5-workshop/10-using-chatbot/><b>10. </b>Sử dụng Chatbot
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/11-admin-dashboard/ title="Sử dụng Admin Dashboard" class=dd-item><a href=../../../vi/5-workshop/11-admin-dashboard/><b>11. </b>Sử dụng Admin Dashboard
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/5-workshop/12-cleanup/ title="Dọn dẹp Tài nguyên" class=dd-item><a href=../../../vi/5-workshop/12-cleanup/><b>12. </b>Dọn dẹp Tài nguyên
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/vi/6-self-evaluation/ title="Tự đánh giá" class=dd-item><a href=../../../vi/6-self-evaluation/><b>6. </b>Tự đánh giá
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/vi/7-feedback/ title="Chia sẻ, đóng góp ý kiến" class=dd-item><a href=../../../vi/7-feedback/><b>7. </b>Chia sẻ, đóng góp ý kiến
<i class="fas fa-check read-icon"></i></a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://www.facebook.com/groups/awsstudygroupfcj/><i class='fab fa-facebook'></i> AWS Study Group</a></li></ul></section><section id=prefooter><hr><ul><li><a class=padding><i class="fas fa-language fa-fw"></i><div class=select-style><select id=select-language onchange="location=this.value"><option id=en value=https://crystaljohn.github.io/fcj-workshop/3-blogstranslated/3.2-blog2/>English</option><option id=vi value=https://crystaljohn.github.io/fcj-workshop/vi/3-blogstranslated/3.2-blog2/ selected>Tiếng Việt</option></select><svg id="Capa_1" xmlns:xlink="http://www.w3.org/1999/xlink" width="255" height="255" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255"><g><g id="arrow-drop-down"><polygon points="0,63.75 127.5,191.25 255,63.75"/></g></g></svg></div></a></li><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></section><section id=footer><left><b>Workshop</b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title=Migrate alt="web counter" border=0></a><br><b><a href=https://cloudjourney.awsstudygroup.com/>Cloud Journey</a></b><br><img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" alt="web counter" border=0>
</left><left><br><br><b>Last Updated</b><br><i><span id=lastUpdated style=color:orange></span>
</i><script>const today=new Date,formattedDate=today.toLocaleDateString("en-GB");document.getElementById("lastUpdated").textContent=formattedDate</script></left><left><br><br><b>Team</b><br><i><a href=https://www.facebook.com/groups/660548818043427 style=color:orange>First Cloud Journey</a><br></i></left><script async defer src=https://buttons.github.io/buttons.js></script></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=../../../vi/>Báo cáo thực tập</a> > <a href=../../../vi/3-blogstranslated/>Các Blog Đã Dịch</a> > Xây dựng pipeline Apache Spark end-to-end với Amazon MWAA, Batch Processing Gateway và Amazon EMR trên EKS</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#bởi-avinash-desireddy-và-suvojit-dasgupta>Bởi: Avinash Desireddy và Suvojit Dasgupta</a></li><li><a href=#tổng-quan-về-giải-pháp>Tổng quan về giải pháp</a></li><li><a href=#airflow-custom-operator-cho-bpg>Airflow custom operator cho BPG</a></li><li><a href=#triển-khai-giải-pháp>Triển khai giải pháp</a><ul><li><a href=#điều-kiện-tiên-quyết>Điều kiện tiên quyết</a></li><li><a href=#cài-đặt-cơ-sở-hạ-tầng-chung>Cài đặt cơ sở hạ tầng chung</a></li><li><a href=#cài-đặt-batch-processing-gateway>Cài đặt Batch Processing Gateway</a></li><li><a href=#cấu-hình-airflow-operator-cho-bpg-trên-amazon-mwaa>Cấu hình Airflow operator cho BPG trên Amazon MWAA</a></li><li><a href=#cấu-hình-airflow-connections-cho-tích-hợp-bpg>Cấu hình Airflow connections cho tích hợp BPG</a></li><li><a href=#cấu-hình-airflow-dag-để-thực-thi-các-công-việc-spark>Cấu hình Airflow DAG để thực thi các công việc Spark</a></li><li><a href=#kích-hoạt-amazon-mwaa-dag>Kích hoạt Amazon MWAA DAG</a></li></ul></li><li><a href=#di-chuyển-các-dag-airflow-hiện-có-để-sử-dụng-bpg>Di chuyển các DAG Airflow hiện có để sử dụng BPG</a></li><li><a href=#dọn-dẹp>Dọn dẹp</a></li><li><a href=#kết-luận>Kết luận</a></li><li><a href=#về-các-tác-giả>Về các tác giả</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Xây dựng pipeline Apache Spark end-to-end với Amazon MWAA, Batch Processing Gateway và Amazon EMR trên EKS</h1><h2 id=bởi-avinash-desireddy-và-suvojit-dasgupta>Bởi: Avinash Desireddy và Suvojit Dasgupta</h2><p><strong>Ngày:</strong> 01 tháng 5 năm 2025</p><p><strong>Chủ đề:</strong> <a href=https://aws.amazon.com/emr/features/eks/>Amazon EMR on EKS</a>, <a href=https://aws.amazon.com/managed-workflows-for-apache-airflow/>Amazon Managed Workflows for Apache Airflow (Amazon MWAA)</a>, <a href=https://aws.amazon.com/big-data/>AWS Big Data</a>, <a href=https://aws.amazon.com/blogs/big-data/category/learning-level/intermediate-200/>Cấp độ Trung cấp (200)</a>, <a href=https://aws.amazon.com/opensource/>Mã nguồn mở</a></p><hr><p>Các workload <a href=https://spark.apache.org/>Apache Spark</a> chạy trên <a href=https://aws.amazon.com/emr/features/emr-on-eks/>Amazon EMR on EKS</a> là nền tảng của nhiều nền tảng dữ liệu hiện đại. EMR trên EKS mang lại lợi ích bằng cách cung cấp một môi trường Spark được quản lý, tích hợp liền mạch với các dịch vụ AWS khác và các mẫu triển khai dựa trên Kubernetes hiện có của tổ chức bạn.</p><p>Các nền tảng dữ liệu xử lý khối lượng dữ liệu quy mô lớn thường yêu cầu nhiều cụm EMR on EKS. Trong bài viết <a href=https://aws.amazon.com/blogs/big-data/use-batch-processing-gateway-to-automate-job-management-in-multi-cluster-amazon-emr-on-eks-environments/>Sử dụng Batch Processing Gateway để tự động hóa quản lý công việc trong môi trường Amazon EMR on EKS đa cụm</a>, chúng tôi đã giới thiệu <strong>Batch Processing Gateway (BPG)</strong> như một giải pháp để quản lý các workload Spark trên các cụm này. Mặc dù BPG cung cấp chức năng nền tảng để phân phối workload và hỗ trợ định tuyến cho các công việc Spark trong môi trường đa cụm, các nền tảng dữ liệu doanh nghiệp đòi hỏi các tính năng bổ sung cho một pipeline xử lý dữ liệu toàn diện.</p><p>Bài viết này chỉ ra cách nâng cao giải pháp đa cụm bằng cách tích hợp <a href=https://aws.amazon.com/mwaa/>Amazon Managed Workflows for Apache Airflow</a> (Amazon MWAA) với BPG. Bằng cách sử dụng Amazon MWAA, chúng tôi thêm vào khả năng lập lịch và điều phối công việc, cho phép bạn xây dựng một pipeline xử lý dữ liệu dựa trên Spark end-to-end toàn diện.</p><hr><h2 id=tổng-quan-về-giải-pháp>Tổng quan về giải pháp</h2><p>Hãy xem xét HealthTech Analytics, một công ty phân tích y tế quản lý hai workload xử lý dữ liệu riêng biệt. Đội ngũ Khoa học Dữ liệu Clinical Insights của họ xử lý dữ liệu nhạy cảm về kết quả bệnh nhân, yêu cầu tuân thủ HIPAA và tài nguyên chuyên dụng. Trong khi đó, đội ngũ Digital Analytics xử lý dữ liệu tương tác website với các yêu cầu linh hoạt hơn. Khi hoạt động của họ phát triển, họ đối mặt với những thách thức ngày càng tăng trong việc quản lý hiệu quả các workload đa dạng này.</p><p>Công ty cần duy trì sự tách biệt nghiêm ngặt giữa việc xử lý thông tin sức khỏe được bảo vệ (PHI) và dữ liệu không phải PHI, đồng thời giải quyết các yêu cầu về trung tâm chi phí khác nhau. Đội ngũ Clinical Insights chạy các quy trình batch quan trọng vào cuối ngày cần tài nguyên được đảm bảo, trong khi đội ngũ Digital Analytics có thể sử dụng các spot instance được tối ưu hóa về chi phí cho các workload biến đổi của họ. Ngoài ra, các nhà khoa học dữ liệu từ cả hai đội đều yêu cầu môi trường để thử nghiệm và tạo mẫu khi cần.</p><p>Kịch bản này là một trường hợp sử dụng lý tưởng để triển khai pipeline dữ liệu bằng Amazon MWAA, BPG và nhiều cụm EMR on EKS. Giải pháp cần định tuyến các workload Spark khác nhau đến các cụm phù hợp dựa trên yêu cầu bảo mật và hồ sơ chi phí, trong khi vẫn duy trì sự cô lập và các biện pháp kiểm soát tuân thủ cần thiết. Để quản lý hiệu quả một môi trường như vậy, chúng ta cần một giải pháp duy trì sự tách biệt rõ ràng giữa các mối quan tâm về quản lý ứng dụng và cơ sở hạ tầng, và kết nối nhiều thành phần lại với nhau thành một pipeline mạnh mẽ.</p><p>Giải pháp của chúng tôi bao gồm việc tích hợp Amazon MWAA với BPG thông qua một <a href=https://airflow.apache.org/docs/apache-airflow/stable/howto/custom-operator.html>Airflow custom operator</a> cho BPG được gọi là <strong>BPGOperator</strong>. Operator này đóng gói logic quản lý cơ sở hạ tầng cần thiết để tương tác với BPG. <code>BPGOperator</code> cung cấp một giao diện rõ ràng để gửi công việc thông qua Amazon MWAA. Khi được thực thi, operator giao tiếp với BPG, sau đó BPG sẽ định tuyến các workload Spark đến các cụm EMR on EKS có sẵn dựa trên các quy tắc định tuyến được xác định trước.</p><p>Sơ đồ kiến trúc sau đây minh họa các thành phần và sự tương tác của chúng.</p><p><img alt="Kiến trúc giải pháp" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-architecture.png></p><p>Giải pháp hoạt động qua các bước sau:</p><ol><li><strong>Amazon MWAA</strong> thực thi các <a href=https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/dags.html>DAGs</a> đã được lập lịch bằng <code>BPGOperator</code>. Các kỹ sư dữ liệu tạo DAG bằng operator này, chỉ yêu cầu tệp cấu hình ứng dụng Spark và các tham số lập lịch cơ bản.</li><li><strong><code>BPGOperator</code></strong> xác thực và gửi công việc đến endpoint của BPG <code>POST:/apiv2/spark</code>. Nó xử lý tất cả các chi tiết giao tiếp HTTP, quản lý token xác thực và cung cấp việc truyền tải an toàn các cấu hình công việc.</li><li><strong>BPG</strong> định tuyến các công việc đã gửi đến các cụm EMR on EKS dựa trên các quy tắc định tuyến được xác định trước. Các quy tắc này được quản lý tập trung thông qua cấu hình của BPG, cho phép phân phối workload dựa trên quy tắc trên nhiều cụm.</li><li><strong><code>BPGOperator</code></strong> giám sát trạng thái công việc, ghi lại log và xử lý việc thử lại thực thi. Nó thăm dò endpoint trạng thái công việc của BPG <code>GET:/apiv2/spark/{subID}/status</code> và truyền log đến Airflow bằng cách thăm dò endpoint <code>GET:/apiv2/log</code> mỗi giây. Endpoint log của BPG lấy thông tin log mới nhất trực tiếp từ Spark Driver Pod.</li><li>Việc thực thi DAG tiến tới các task tiếp theo dựa trên trạng thái hoàn thành của công việc và các phụ thuộc đã xác định. <code>BPGOperator</code> truyền đạt trạng thái công việc thông qua hệ thống giao tiếp task tích hợp của Airflow, cho phép điều phối workflow phức tạp.</li></ol><p>Tham khảo tài liệu <a href=https://github.com/aws-samples/amazon-emr-on-eks-batch-processing-gateway/blob/main/docs/api-spec/openapi.yaml>giao diện REST API</a> của BPG để biết thêm chi tiết.</p><p>Kiến trúc này cung cấp một số lợi ích chính:</p><ul><li><strong>Tách biệt trách nhiệm</strong> – Các đội Kỹ thuật Dữ liệu và Kỹ thuật Nền tảng trong các tổ chức doanh nghiệp thường duy trì các trách nhiệm riêng biệt. Thiết kế mô-đun trong giải pháp này cho phép các kỹ sư nền tảng cấu hình <code>BPGOperator</code> và quản lý các cụm EMR on EKS, trong khi các kỹ sư dữ liệu duy trì DAGs.</li><li><strong>Quản lý mã nguồn tập trung</strong> – <code>BPGOperator</code> đóng gói tất cả các chức năng cốt lõi cần thiết để các DAG của Amazon MWAA gửi công việc Spark thông qua BPG vào một mô-đun Python duy nhất, có thể tái sử dụng. Việc tập trung này giảm thiểu sự trùng lặp mã nguồn giữa các DAG và cải thiện khả năng bảo trì bằng cách cung cấp một giao diện chuẩn hóa để gửi công việc.</li></ul><hr><h2 id=airflow-custom-operator-cho-bpg>Airflow custom operator cho BPG</h2><p>Một <a href=https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/operators.html>Operator</a> trong Airflow là một mẫu cho một <a href=https://airflow.apache.org/docs/apache-airflow/stable/core-concepts/tasks.html>Task</a> được xác định trước mà bạn có thể định nghĩa một cách khai báo bên trong DAG của mình. Airflow cung cấp nhiều operator tích hợp sẵn như <code>BashOperator</code> để thực thi các lệnh bash, <code>PythonOperator</code> để thực thi các hàm Python, và <code>EmrContainerOperator</code> để gửi công việc mới đến một cụm EMR on EKS. Tuy nhiên, không có operator tích hợp nào để thực hiện tất cả các bước cần thiết cho việc tích hợp Amazon MWAA với BPG.</p><p>Airflow cho phép bạn tạo các operator mới để phù hợp với yêu cầu cụ thể của mình. Loại operator này được gọi là <strong>custom operator</strong>. Một custom operator đóng gói logic liên quan đến cơ sở hạ tầng tùy chỉnh vào một thành phần duy nhất, có thể bảo trì. Custom operator được tạo bằng cách mở rộng lớp <code>airflow.models.baseoperator.BaseOperator</code>. Chúng tôi đã phát triển và mã nguồn mở một Airflow custom operator cho BPG có tên là <strong><code>BPGOperator</code></strong>, thực hiện các bước cần thiết để cung cấp sự tích hợp liền mạch của Amazon MWAA với BPG.</p><p>Sơ đồ lớp sau đây cung cấp một cái nhìn chi tiết về việc triển khai <code>BPGOperator</code>.</p><p><img alt="Sơ đồ lớp BPGOperator" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-bpg-operator-class-diagram.png></p><p>Khi một DAG bao gồm một task <code>BPGOperator</code>, instance của Amazon MWAA sẽ kích hoạt operator để gửi một yêu cầu công việc đến BPG. Operator thường thực hiện các bước sau:</p><ol><li><strong>Khởi tạo công việc</strong> – <code>BPGOperator</code> chuẩn bị payload của công việc, bao gồm các tham số đầu vào, cấu hình, chi tiết kết nối và các siêu dữ liệu khác mà BPG yêu cầu.</li><li><strong>Gửi công việc</strong> – <code>BPGOperator</code> xử lý các yêu cầu HTTP POST để gửi công việc đến các endpoint của BPG với các cấu hình đã cung cấp.</li><li><strong>Giám sát thực thi công việc</strong> – <code>BPGOperator</code> kiểm tra trạng thái công việc, thăm dò BPG cho đến khi công việc hoàn thành thành công hoặc thất bại. Quá trình giám sát bao gồm xử lý các trạng thái công việc khác nhau, quản lý các kịch bản timeout và phản ứng với các lỗi xảy ra trong quá trình thực thi công việc.</li><li><strong>Xử lý hoàn thành công việc</strong> – Khi hoàn thành, <code>BPGOperator</code> ghi lại kết quả của công việc, log các chi tiết liên quan và có thể kích hoạt các task sau đó dựa trên kết quả thực thi.</li></ol><p>Sơ đồ tuần tự sau đây minh họa luồng tương tác giữa Airflow DAG, <code>BPGOperator</code> và BPG.</p><p><img alt="Sơ đồ tuần tự" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-bgp-operator-sequence-diagram.png></p><hr><h2 id=triển-khai-giải-pháp>Triển khai giải pháp</h2><p>Trong phần còn lại của bài viết này, bạn sẽ triển khai pipeline end-to-end để chạy các công việc Spark trên nhiều cụm EMR on EKS. Bạn sẽ bắt đầu bằng cách triển khai các thành phần chung làm nền tảng để xây dựng các pipeline. Tiếp theo, bạn sẽ triển khai và cấu hình BPG trên một cụm EKS, sau đó là triển khai và cấu hình <code>BPGOperator</code> trên Amazon MWAA. Cuối cùng, bạn sẽ thực thi các công việc Spark trên nhiều cụm EMR on EKS từ Amazon MWAA.</p><p>Để hợp lý hóa quá trình cài đặt, chúng tôi đã tự động hóa việc triển khai tất cả các thành phần cơ sở hạ tầng cần thiết cho bài viết này, vì vậy bạn có thể tập trung vào các khía cạnh thiết yếu của việc gửi công việc để xây dựng một pipeline end-to-end. Chúng tôi cung cấp thông tin chi tiết để giúp bạn hiểu từng bước, đơn giản hóa việc thiết lập trong khi vẫn giữ được trải nghiệm học hỏi.</p><p>Để trình diễn giải pháp, bạn sẽ tạo ba cụm và một môi trường Amazon MWAA:</p><ul><li>Hai cụm EMR on EKS: <code>analytics-cluster</code> và <code>datascience-cluster</code></li><li>Một cụm EKS: <code>gateway-cluster</code></li><li>Một môi trường Amazon MWAA: <code>airflow-environment</code></li></ul><p><code>analytics-cluster</code> và <code>datascience-cluster</code> đóng vai trò là các cụm xử lý dữ liệu chạy các workload Spark, <code>gateway-cluster</code> lưu trữ BPG, và <code>airflow-environment</code> lưu trữ Airflow để điều phối và lập lịch công việc.</p><p>Bạn có thể tìm mã nguồn trong <a href=https://github.com/aws-samples/sample-mwaa-bpg-emr-on-eks-spark-pipeline>kho lưu trữ GitHub</a>.</p><h3 id=điều-kiện-tiên-quyết>Điều kiện tiên quyết</h3><p>Trước khi triển khai giải pháp này, hãy đảm bảo rằng các điều kiện tiên quyết sau đã được đáp ứng:</p><ul><li>Quyền truy cập vào một tài khoản AWS hợp lệ</li><li><a href=https://aws.amazon.com/cli/>AWS Command Line Interface</a> (AWS CLI) được <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html>cài đặt</a> trên máy cục bộ của bạn</li><li>Các tiện ích Git, <a href=https://docs.docker.com/get-docker/>Docker</a>, <a href=https://eksctl.io/>eksctl</a>, <a href=https://kubernetes.io/docs/tasks/tools/>kubectl</a>, <a href=https://helm.sh/docs/intro/install/>Helm</a>, và <a href=https://stedolan.github.io/jq/download/>jq</a> được cài đặt trên máy cục bộ của bạn</li><li>Quyền tạo tài nguyên AWS</li><li>Quen thuộc với Kubernetes, Amazon MWAA, Apache Spark, <a href=https://aws.amazon.com/eks/>Amazon Elastic Kubernetes Service</a> (Amazon EKS), và Amazon EMR on EKS</li></ul><h3 id=cài-đặt-cơ-sở-hạ-tầng-chung>Cài đặt cơ sở hạ tầng chung</h3><p>Bước này xử lý việc cài đặt cơ sở hạ tầng mạng, bao gồm virtual private cloud (VPC) và subnets, cùng với việc cấu hình các vai trò <a href=https://aws.amazon.com/iam/>AWS Identity and Access Management</a> (IAM), lưu trữ <a href=https://aws.amazon.com/s3/>Amazon Simple Storage Service</a> (Amazon S3), kho lưu trữ <a href=https://aws.amazon.com/ecr/>Amazon Elastic Container Registry</a> (Amazon ECR) cho các image BPG, cơ sở dữ liệu <a href=https://aws.amazon.com/rds/aurora/postgresql-features/>Amazon Aurora PostgreSQL-Compatible Edition</a>, môi trường Amazon MWAA, và cả cụm EKS và EMR on EKS với một Spark operator được cấu hình sẵn. Với cơ sở hạ tầng này được cấp phát tự động, bạn có thể tập trung vào các bước tiếp theo mà không bị vướng vào các tác vụ cài đặt cơ bản.</p><p>Clone kho lưu trữ về máy cục bộ của bạn và đặt hai biến môi trường. Thay thế <code>&lt;AWS_REGION></code> bằng Vùng AWS nơi bạn muốn triển khai các tài nguyên này.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/aws-samples/sample-mwaa-bpg-emr-on-eks-spark-pipeline.git
</span></span><span style=display:flex><span>cd sample-mwaa-bpg-emr-on-eks-spark-pipeline
</span></span><span style=display:flex><span>export REPO_DIR<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>export AWS_REGION<span style=color:#f92672>=</span>&lt;AWS_REGION&gt;
</span></span></code></pre></div><p>Thực thi script sau để tạo cơ sở hạ tầng chung:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd <span style=color:#e6db74>${</span>REPO_DIR<span style=color:#e6db74>}</span>/infra
</span></span><span style=display:flex><span>./setup.sh
</span></span></code></pre></div><p>Để xác minh việc triển khai cơ sở hạ tầng thành công, hãy điều hướng đến <a href=https://console.aws.amazon.com/cloudformation/home>bảng điều khiển AWS CloudFormation</a>, mở stack của bạn và kiểm tra các tab <strong>Events</strong>, <strong>Resources</strong>, và <strong>Outputs</strong> để xem trạng thái hoàn thành, chi tiết và danh sách các tài nguyên đã tạo.</p><p>Bạn đã hoàn thành việc thiết lập các thành phần chung làm nền tảng cho phần còn lại của việc triển khai.</p><h3 id=cài-đặt-batch-processing-gateway>Cài đặt Batch Processing Gateway</h3><p>Phần này xây dựng image Docker cho BPG, triển khai helm chart trên cụm EKS <code>gateway-cluster</code>, và phơi bày endpoint của BPG bằng cách sử dụng service Kubernetes loại <code>LoadBalancer</code>. Hoàn thành các bước sau:</p><ol><li>Triển khai BPG trên cụm EKS <code>gateway-cluster</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd <span style=color:#e6db74>${</span>REPO_DIR<span style=color:#e6db74>}</span>/infra/bpg
</span></span><span style=display:flex><span>./configure_bpg.sh
</span></span></code></pre></div><ol start=2><li>Xác minh việc triển khai bằng cách liệt kê các pod và xem log của pod:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods --namespace bpg
</span></span><span style=display:flex><span>kubectl logs &lt;BPG-PODNAME&gt; --namespace bpg
</span></span></code></pre></div><p>Xem lại các log và xác nhận không có lỗi hoặc ngoại lệ.</p><ol start=3><li>Exec vào pod BPG và xác minh health check:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl exec -it &lt;BPG-PODNAME&gt; -n bpg -- bash
</span></span><span style=display:flex><span>curl -u admin:admin localhost:8080/skatev2/healthcheck/status
</span></span></code></pre></div><p>API <code>healthcheck</code> sẽ trả về phản hồi thành công là <code>{"status":"OK"}</code>, xác nhận việc triển khai BPG thành công trên cụm EKS <code>gateway-cluster</code>.</p><p>Chúng ta đã cấu hình thành công BPG trên <code>gateway-cluster</code> và thiết lập EMR on EKS cho cả <code>datascience-cluster</code> và <code>analytics-cluster</code>. Đây là điểm chúng ta đã dừng lại trong bài blog trước. Trong các bước tiếp theo, chúng ta sẽ cấu hình Amazon MWAA với <code>BPGOperator</code>, sau đó viết và gửi DAG để minh họa một pipeline dữ liệu dựa trên Spark end-to-end.</p><h3 id=cấu-hình-airflow-operator-cho-bpg-trên-amazon-mwaa>Cấu hình Airflow operator cho BPG trên Amazon MWAA</h3><p>Phần này cấu hình plugin <code>BPGOperator</code> trên môi trường Amazon MWAA <code>airflow-environment</code>.</p><ol><li>Cấu hình <code>BPGOperator</code> trên Amazon MWAA:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd <span style=color:#e6db74>${</span>REPO_DIR<span style=color:#e6db74>}</span>/bpg_operator
</span></span><span style=display:flex><span>./configure_bpg_operator.sh
</span></span></code></pre></div><ol start=2><li>Trên bảng điều khiển Amazon MWAA, điều hướng đến môi trường <code>airflow-environment</code>.</li><li>Chọn <strong>Open Airflow UI</strong>, và trong giao diện Airflow, chọn menu thả xuống <strong>Admin</strong> và chọn <strong>Plugins</strong>.</li><li>Bạn sẽ thấy plugin <code>BPGOperator</code> được liệt kê trong giao diện Airflow.</li></ol><p><img alt="Plugin BPGOperator" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-mwaa-plugin.png></p><h3 id=cấu-hình-airflow-connections-cho-tích-hợp-bpg>Cấu hình Airflow connections cho tích hợp BPG</h3><p>Phần này hướng dẫn bạn thiết lập các Airflow connection cho phép giao tiếp an toàn giữa môi trường Amazon MWAA và BPG. <code>BPGOperator</code> sử dụng connection đã cấu hình để xác thực và tương tác với các endpoint của BPG.</p><p>Thực thi script sau để cấu hình Airflow connection <code>bpg_connection</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd $REPO_DIR/airflow
</span></span><span style=display:flex><span>./configure_connections.sh
</span></span></code></pre></div><p>Trong giao diện Airflow, chọn menu thả xuống <strong>Admin</strong> và chọn <strong>Connections</strong>. Bạn sẽ thấy <code>bpg_connection</code> được liệt kê.</p><p><img alt="Airflow Connections" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-airflow-connection.png></p><h3 id=cấu-hình-airflow-dag-để-thực-thi-các-công-việc-spark>Cấu hình Airflow DAG để thực thi các công việc Spark</h3><p>Bước này cấu hình một Airflow DAG để chạy một ứng dụng mẫu. Cụ thể, chúng tôi sẽ gửi một DAG chứa nhiều công việc Spark mẫu bằng Amazon MWAA đến các cụm EMR on EKS sử dụng BPG. Vui lòng đợi vài phút để DAG xuất hiện trong giao diện Airflow.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd $REPO_DIR/jobs
</span></span><span style=display:flex><span>./configure_job.sh
</span></span></code></pre></div><h3 id=kích-hoạt-amazon-mwaa-dag>Kích hoạt Amazon MWAA DAG</h3><p>Trong bước này, chúng tôi kích hoạt Airflow DAG và quan sát hành vi thực thi công việc, bao gồm cả việc xem lại log Spark trong giao diện Airflow:</p><ol><li>Trong giao diện Airflow, xem lại DAG <code>MWAASparkPipelineDemoJob</code> và chọn biểu tượng play để kích hoạt DAG.</li></ol><p><img alt="Kích hoạt DAG" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-dags.png></p><ol start=2><li>Đợi DAG hoàn thành thành công.</li><li>Khi DAG hoàn thành thành công, bạn sẽ thấy <code>Success:1</code> dưới cột <strong>Runs</strong>.</li><li>Trong giao diện Airflow, tìm và chọn DAG <code>MWAASparkPipelineDemoJob</code>.</li></ol><p><img alt="DAG thành công" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-dag-graphview.png></p><ol start=5><li>Trên tab <strong>Graph</strong>, chọn bất kỳ task nào (ví dụ, chúng tôi chọn task <code>calculate_pi</code>) và sau đó chọn <strong>Logs</strong>.</li></ol><p><img alt="Xem Logs" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-mwaa-job-logs.png></p><ol start=6><li>Xem log Spark trong giao diện Airflow.</li></ol><hr><h2 id=di-chuyển-các-dag-airflow-hiện-có-để-sử-dụng-bpg>Di chuyển các DAG Airflow hiện có để sử dụng BPG</h2><p>Trong các nền tảng dữ liệu doanh nghiệp, một pipeline dữ liệu điển hình bao gồm Amazon MWAA gửi các công việc Spark đến nhiều cụm EMR on EKS bằng cách sử dụng <code>SparkKubernetesOperator</code> và một <code>Airflow Connection</code> loại Kubernetes. Một Airflow Connection là một tập hợp các tham số và thông tin xác thực được sử dụng để thiết lập giao tiếp giữa Amazon MWAA và các hệ thống hoặc dịch vụ bên ngoài. Một DAG tham chiếu đến tên connection và kết nối đến hệ thống bên ngoài.</p><p>Sơ đồ sau đây cho thấy kiến trúc điển hình.</p><p><img alt="Kiến trúc điển hình" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-mwaa-existing.png></p><p>Trong thiết lập này, các DAG Airflow thường sử dụng <code>SparkKubernetesOperator</code> và <code>SparkKubernetesSensor</code> để gửi công việc Spark đến một cụm EMR on EKS từ xa bằng cách sử dụng <code>kubernetes_conn_id=&lt;connection_name></code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Gửi công việc Spark-Pi bằng Kubernetes connection</span>
</span></span><span style=display:flex><span>submit_spark_pi <span style=color:#f92672>=</span> SparkKubernetesOperator(
</span></span><span style=display:flex><span>    task_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;submit_spark_pi&#39;</span>,
</span></span><span style=display:flex><span>    namespace<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;default&#39;</span>,
</span></span><span style=display:flex><span>    application_file<span style=color:#f92672>=</span>spark_pi_yaml,
</span></span><span style=display:flex><span>    kubernetes_conn_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;emr_on_eks_connection_[1|2]&#39;</span>,  <span style=color:#75715e># Connection ID được định nghĩa trong Airflow</span>
</span></span><span style=display:flex><span>    dag<span style=color:#f92672>=</span>dag)
</span></span></code></pre></div><p>Để di chuyển cơ sở hạ tầng sang cơ sở hạ tầng dựa trên BPG mà không ảnh hưởng đến tính liên tục của môi trường, chúng ta có thể triển khai một cơ sở hạ tầng song song sử dụng BPG, tạo một Airflow Connection mới cho BPG, và di chuyển dần các DAG để sử dụng connection mới. Bằng cách làm như vậy, chúng ta sẽ không làm gián đoạn cơ sở hạ tầng hiện có cho đến khi cơ sở hạ tầng dựa trên BPG hoàn toàn hoạt động, bao gồm cả việc di chuyển tất cả các DAG hiện có.</p><p>Sơ đồ sau đây giới thiệu trạng thái tạm thời nơi cả kết nối Kubernetes và kết nối BPG đều hoạt động. Mũi tên màu xanh chỉ ra các đường dẫn workflow hiện có, và mũi tên màu đỏ đại diện cho các đường dẫn di chuyển mới dựa trên BPG.</p><p><img alt="Trạng thái di chuyển" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-mwaa-bpg-migration.png></p><p>Đoạn mã được sửa đổi cho DAG như sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Gửi công việc Spark-Pi bằng BPG connection</span>
</span></span><span style=display:flex><span>submit_spark_pi <span style=color:#f92672>=</span> BPGOperator(
</span></span><span style=display:flex><span>    task_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;submit_spark_pi&#39;</span>,
</span></span><span style=display:flex><span>    application_file<span style=color:#f92672>=</span>spark_pi_yaml,
</span></span><span style=display:flex><span>    application_file_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;yaml&#39;</span>,
</span></span><span style=display:flex><span>    connection_id<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;bpg_connection&#39;</span>,  <span style=color:#75715e># Connection ID được định nghĩa trong Airflow</span>
</span></span><span style=display:flex><span>    dag<span style=color:#f92672>=</span>dag)
</span></span></code></pre></div><p>Cuối cùng, khi tất cả các DAG đã được sửa đổi để sử dụng <code>BPGOperator</code> thay vì <code>SparkKubernetesOperator</code>, bạn có thể ngừng hoạt động bất kỳ tàn dư nào của workflow cũ. Trạng thái cuối cùng của cơ sở hạ tầng sẽ trông giống như sơ đồ sau.</p><p><img alt="Trạng thái cuối cùng" src=../../../images/3-BlogsTranslated/3.2-Blog2/bdb-5005-mwaa-bpg-final-1.png></p><p>Sử dụng phương pháp này, chúng ta có thể tích hợp BPG một cách liền mạch vào một môi trường hiện chỉ sử dụng Amazon MWAA và các cụm EMR on EKS.</p><hr><h2 id=dọn-dẹp>Dọn dẹp</h2><p>Để tránh phát sinh các khoản phí trong tương lai từ các tài nguyên được tạo trong hướng dẫn này, hãy dọn dẹp môi trường của bạn sau khi đã hoàn thành các bước. Bạn có thể làm điều này bằng cách chạy script <code>cleanup.sh</code>, script này sẽ xóa an toàn tất cả các tài nguyên đã được cấp phát trong quá trình thiết lập:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd <span style=color:#e6db74>${</span>REPO_DIR<span style=color:#e6db74>}</span>/setup
</span></span><span style=display:flex><span>./cleanup.sh
</span></span></code></pre></div><hr><h2 id=kết-luận>Kết luận</h2><p>Trong bài viết <a href=https://aws.amazon.com/blogs/big-data/use-batch-processing-gateway-to-automate-job-management-in-multi-cluster-amazon-emr-on-eks-environments/>Sử dụng Batch Processing Gateway để tự động hóa quản lý công việc trong môi trường Amazon EMR on EKS đa cụm</a>, chúng tôi đã giới thiệu Batch Processing Gateway như một giải pháp để định tuyến các workload Spark trên nhiều cụm EMR on EKS. Trong bài viết này, chúng tôi đã chứng minh cách nâng cao nền tảng này bằng cách tích hợp BPG với Amazon MWAA. Thông qua <code>BPGOperator</code> tùy chỉnh của chúng tôi, chúng tôi đã chỉ ra cách xây dựng các pipeline xử lý dữ liệu dựa trên Spark end-to-end mạnh mẽ trong khi vẫn duy trì sự tách biệt rõ ràng về trách nhiệm và quản lý mã nguồn tập trung. Cuối cùng, chúng tôi đã chứng minh cách tích hợp liền mạch giải pháp vào nền tảng dữ liệu Amazon MWAA và EMR on EKS hiện có của bạn mà không ảnh hưởng đến tính liên tục hoạt động.</p><p>Chúng tôi khuyến khích bạn thử nghiệm kiến trúc này trong môi trường của riêng mình, điều chỉnh nó để phù hợp với các workload và yêu cầu hoạt động độc đáo của bạn. Bằng cách triển khai giải pháp này, bạn có thể xây dựng các pipeline xử lý dữ liệu hiệu quả và có khả năng mở rộng, tận dụng toàn bộ tiềm năng của EMR on EKS và Amazon MWAA. Hãy khám phá thêm bằng cách triển khai giải pháp trong tài khoản AWS của bạn trong khi tuân thủ các phương pháp bảo mật tốt nhất của tổ chức và chia sẻ kinh nghiệm của bạn với cộng đồng Dữ liệu lớn của AWS.</p><hr><h2 id=về-các-tác-giả>Về các tác giả</h2><p><strong>Suvojit Dasgupta</strong> là một Kiến trúc sư Dữ liệu Chính tại AWS. Anh dẫn dắt một đội ngũ kỹ sư lành nghề trong việc thiết kế và xây dựng các giải pháp dữ liệu có khả năng mở rộng cho khách hàng của AWS. Anh chuyên phát triển và triển khai các kiến trúc dữ liệu sáng tạo để giải quyết các thách thức kinh doanh phức tạp.</p><p><strong>Avinash Desireddy</strong> là một Kiến trúc sư Cơ sở hạ tầng Đám mây tại AWS, đam mê xây dựng các ứng dụng và nền tảng dữ liệu an toàn. Anh có kinh nghiệm sâu rộng về Kubernetes, DevOps và kiến trúc doanh nghiệp, giúp khách hàng container hóa ứng dụng, hợp lý hóa việc triển khai và tối ưu hóa môi trường cloud-native.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=../../../vi/3-blogstranslated/3.1-blog1/ title="Xây dựng nhà khí tượng ảo bằng Amazon Bedrock Agents"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=../../../vi/3-blogstranslated/3.3-blog3/ title="Xây dựng Golden Image với CIS Linux Build Kit trong Amazon EC2 Image Builder" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=../../../js/clipboard.min.js?1765512673></script><script src=../../../js/perfect-scrollbar.min.js?1765512673></script><script src=../../../js/perfect-scrollbar.jquery.min.js?1765512673></script><script src=../../../js/jquery.sticky.js?1765512673></script><script src=../../../js/featherlight.min.js?1765512673></script><script src=../../../js/highlight.pack.js?1765512673></script><script>hljs.initHighlightingOnLoad()</script><script src=../../../js/modernizr.custom-3.6.0.js?1765512673></script><script src=../../../js/learn.js?1765512673></script><script src=../../../js/hugo-learn.js?1765512673></script><link href=../../../mermaid/mermaid.css?1765512673 rel=stylesheet><script src=../../../mermaid/mermaid.js?1765512673></script><script>mermaid.initialize({startOnLoad:!0})</script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,(e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date),(i=t.createElement(n),a=t.getElementsByTagName(n)[0]),i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-158079754-2","auto"),ga("send","pageview")</script></body></html>